<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0095)http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title xmlns:d="http://docbook.org/ns/docbook">Clusters from Scratch</title><link rel="stylesheet" type="text/css" href="./Clusters from Scratch_files/default.css"><link rel="stylesheet" media="print" href="./Clusters from Scratch_files/print.css" type="text/css"><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.1.3"><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content="Pacemaker-Clusters_from_Scratch-1.1-pcs-en-US-7-0"><meta name="description" content="The purpose of this document is to provide a start-to-finish guide to building an example active/passive cluster with Pacemaker and show how it can be converted to an active/active one. The example cluster will use: Fedora 17 as the host operating system Corosync to provide messaging and membership services, Pacemaker to perform resource management, DRBD as a cost-effective alternative to shared storage, GFS2 as the cluster filesystem (in active/active mode) Given the graphical nature of the Fedora install process, a number of screenshots are included. However the guide is primarily composed of commands, the reasons for executing them and their expected outputs."></head><body><p id="title"><a class="left" href="http://www.clusterlabs.org/"><img alt="Product Site" src="./Clusters from Scratch_files/image_left.png"></a><a class="right" href="http://www.clusterlabs.org/wiki/Documentation"><img alt="Documentation Site" src="./Clusters from Scratch_files/image_right.png"></a></p><div xml:lang="en-US" class="book" lang="en-US"><div class="titlepage"><div><div class="producttitle" font-family="sans-serif,Symbol,ZapfDingbats" font-weight="bold" font-size="12pt" text-align="center"><span xmlns:d="http://docbook.org/ns/docbook" class="productname">Pacemaker</span> <span xmlns:d="http://docbook.org/ns/docbook" class="productnumber">1.1</span></div><div font-family="sans-serif,Symbol,ZapfDingbats" font-weight="bold" font-size="12pt" text-align="center"><h1 class="title"><a id="idm254584427936"></a>Clusters from Scratch</h1></div><div font-family="sans-serif,Symbol,ZapfDingbats" font-weight="bold" font-size="12pt" text-align="center"><h2 class="subtitle">Creating Active/Passive and Active/Active Clusters on Fedora</h2></div><p xmlns:d="http://docbook.org/ns/docbook" class="edition">Edition 5</p><div font-family="sans-serif,Symbol,ZapfDingbats" font-weight="bold" font-size="12pt" text-align="center"><h3 class="corpauthor">
		<span class="inlinemediaobject"><object data="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/Common_Content/images/title_logo.svg" type="image/svg+xml"><img src="./Clusters from Scratch_files/title_logo.png" alt=""></object></span>

	</h3></div><div font-family="sans-serif,Symbol,ZapfDingbats" font-weight="bold" font-size="12pt" text-align="center"><div xml:lang="en-US" class="authorgroup" lang="en-US"><div class="author"><h3 class="author"><span class="firstname">Andrew</span> <span class="surname">Beekhof</span></h3><span class="contrib">Primary author</span>&nbsp;<div class="affiliation"><span xmlns:d="http://docbook.org/ns/docbook" class="orgname">Red Hat</span></div><code class="email"><a class="email" href="mailto:andrew@beekhof.net">andrew@beekhof.net</a></code></div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Raoul</span> <span class="surname">Scarazzini</span></h3><span class="contrib">Italian translation</span>&nbsp;<code class="email"><a class="email" href="mailto:rasca@miamammausalinux.org">rasca@miamammausalinux.org</a></code></div><div class="othercredit"><h3 class="othercredit"><span class="firstname">Dan</span> <span class="surname">Frîncu</span></h3><span class="contrib">Romanian translation</span>&nbsp;<code class="email"><a class="email" href="mailto:df.cluster@gmail.com">df.cluster@gmail.com</a></code></div></div></div><div font-family="sans-serif,Symbol,ZapfDingbats" font-weight="bold" font-size="12pt" text-align="center"><div class="legalnotice"><a id="idm254652295664"></a><h1 class="legalnotice">Legal Notice</h1><div class="para">
		Copyright <span class="trademark"></span>© 2009-2012 Andrew Beekhof.
	</div><div class="para">
		The text of and illustrations in this document are licensed under a Creative Commons Attribution–Share Alike 3.0 Unported license ("CC-BY-SA")<a id="idm254527467136">
      ⁠</a><a xmlns:d="http://docbook.org/ns/docbook" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254527467136" class="footnote"><sup class="footnote">[1]</sup></a>.
	</div><div class="para">
		In accordance with CC-BY-SA, if you distribute this document or an adaptation of it, you must provide the URL for the original version.
	</div><div class="para">
		In addition to the requirements of this license, the following activities are looked upon favorably: 
		<div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
					If you are distributing Open Publication works on hardcopy or CD-ROM, you provide email notification to the authors of your intent to redistribute at least thirty days before your manuscript or media freeze, to give the authors time to provide updated documents. This notification should describe modifications, if any, made to the document.
				</div></li><li class="listitem"><div class="para">
					All substantive modifications (including deletions) be either clearly marked up in the document or else described in an attachment to the document.
				</div></li><li class="listitem"><div class="para">
					Finally, while it is not mandatory under this license, it is considered good form to offer a free copy of any hardcopy or CD-ROM expression of the author(s) work.
				</div></li></ol></div>

	</div></div></div><div font-family="sans-serif,Symbol,ZapfDingbats" font-weight="bold" font-size="12pt" text-align="center"><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
			The purpose of this document is to provide a start-to-finish guide to building an example active/passive cluster with Pacemaker and show how it can be converted to an active/active one.
		</div><div class="para">
			The example cluster will use: 
			<div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol><li class="listitem"><div class="para">
						Fedora 17 as the host operating system
					</div></li><li class="listitem"><div class="para">
						Corosync to provide messaging and membership services,
					</div></li><li class="listitem"><div class="para">
						Pacemaker to perform resource management,
					</div></li><li class="listitem"><div class="para">
						DRBD as a cost-effective alternative to shared storage,
					</div></li><li class="listitem"><div class="para">
						GFS2 as the cluster filesystem (in active/active mode)
					</div></li></ol></div>

		</div><div class="para">
			Given the graphical nature of the Fedora install process, a number of screenshots are included. However the guide is primarily composed of commands, the reasons for executing them and their expected outputs.
		</div></div></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="preface"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#pref-Clusters_from_Scratch-Preface">Preface</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254577303632">1. Document Conventions</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254660520592">1.1. Typographic Conventions</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254632800992">1.2. Pull-quote Conventions</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254544989456">1.3. Notes and Warnings</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254584875696">2. We Need Feedback!</a></span></dt></dl></dd><dt><span class="chapter"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254583786528">1. Read-Me-First</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_the_scope_of_this_document">1.1. The Scope of this Document</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_what_is_pacemaker">1.2. What Is Pacemaker?</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_pacemaker_architecture">1.3. Pacemaker Architecture</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_internal_components">1.3.1. Internal Components</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_types_of_pacemaker_clusters">1.4. Types of Pacemaker Clusters</a></span></dt></dl></dd><dt><span class="chapter"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254648951440">2. Installation</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_os_installation">2.1. OS Installation</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_post_installation_tasks">2.2. Post Installation Tasks</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_networking">2.2.1. Networking</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_leaving_the_console">2.2.2. Leaving the Console</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_security_shortcuts">2.2.3. Security Shortcuts</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_short_node_names">2.2.4. Short Node Names</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_before_you_continue">2.3. Before You Continue</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_finalize_networking">2.3.1. Finalize Networking</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configure_ssh">2.3.2. Configure SSH</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_cluster_software_installation">2.4. Cluster Software Installation</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_install_the_cluster_software">2.4.1. Install the Cluster Software</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_install_the_cluster_management_software">2.4.2. Install the Cluster Management Software</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_setup">2.5. Setup</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_enable_pcs_daemon">2.5.1. Enable pcs Daemon</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_notes_on_multicast_address_assignment">2.5.2. Notes on Multicast Address Assignment</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configuring_corosync">2.5.3. Configuring Corosync</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254584266640">3. Pacemaker Tools</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_using_pacemaker_tools">3.1. Using Pacemaker Tools</a></span></dt></dl></dd><dt><span class="chapter"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254653148832">4. Verify Cluster Installation</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_start_the_cluster">4.1. Start the Cluster</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_verify_corosync_installation">4.2. Verify Corosync Installation</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_verify_pacemaker_installation">4.3. Verify Pacemaker Installation</a></span></dt></dl></dd><dt><span class="chapter"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254567492480">5. Creating an Active/Passive Cluster</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_exploring_the_existing_configuration">5.1. Exploring the Existing Configuration</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_adding_a_resource">5.2. Adding a Resource</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_perform_a_failover">5.3. Perform a Failover</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_quorum_and_two_node_clusters">5.3.1. Quorum and Two-Node Clusters</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_prevent_resources_from_moving_after_recovery">5.3.2. Prevent Resources from Moving after Recovery</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254538357344">6. Apache - Adding More Services</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_forward">6.1. Forward</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_installation">6.2. Installation</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_preparation">6.3. Preparation</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_enable_the_apache_status_url">6.4. Enable the Apache status URL</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_update_the_configuration">6.5. Update the Configuration</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_ensuring_resources_run_on_the_same_host">6.6. Ensuring Resources Run on the Same Host</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_controlling_resource_start_stop_ordering">6.7. Controlling Resource Start/Stop Ordering</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_specifying_a_preferred_location">6.8. Specifying a Preferred Location</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_manually_moving_resources_around_the_cluster">6.9. Manually Moving Resources Around the Cluster</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_giving_control_back_to_the_cluster">6.9.1. Giving Control Back to the Cluster</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254658409520">7. Replicated Storage with DRBD</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_background">7.1. Background</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_install_the_drbd_packages">7.2. Install the DRBD Packages</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configure_drbd">7.3. Configure DRBD</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_create_a_partition_for_drbd">7.3.1. Create A Partition for DRBD</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_write_the_drbd_config">7.3.2. Write the DRBD Config</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_initialize_and_load_drbd">7.3.3. Initialize and Load DRBD</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_populate_drbd_with_data">7.3.4. Populate DRBD with Data</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configure_the_cluster_for_drbd">7.4. Configure the Cluster for DRBD</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_testing_migration">7.4.1. Testing Migration</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254658206640">8. Conversion to Active/Active</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_requirements">8.1. Requirements</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_installing_the_required_software">8.1.1. Installing the required Software</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_create_a_gfs2_filesystem">8.2. Create a GFS2 Filesystem</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#GFS2_prep">8.2.1. Preparation</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_create_and_populate_an_gfs2_partition">8.2.2. Create and Populate an GFS2 Partition</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_reconfigure_the_cluster_for_gfs2">8.3. Reconfigure the Cluster for GFS2</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_reconfigure_pacemaker_for_active_active">8.4. Reconfigure Pacemaker for Active/Active</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_testing_recovery">8.4.1. Testing Recovery</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254568673376">9. Configure STONITH</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_what_is_stonith">9.1. What Is STONITH</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_what_stonith_device_should_you_use">9.2. What STONITH Device Should You Use</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configuring_stonith">9.3. Configuring STONITH</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_example">9.4. Example</a></span></dt></dl></dd><dt><span class="appendix"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configuration_recap">A. Configuration Recap</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_final_cluster_configuration">A.1. Final Cluster Configuration</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_node_list">A.2. Node List</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_cluster_options">A.3. Cluster Options</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_resources">A.4. Resources</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_default_options">A.4.1. Default Options</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_fencing">A.4.2. Fencing</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_service_address">A.4.3. Service Address</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_drbd_shared_storage">A.4.4. DRBD - Shared Storage</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_cluster_filesystem">A.4.5. Cluster Filesystem</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_apache">A.4.6. Apache</a></span></dt></dl></dd></dl></dd><dt><span class="appendix"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_sample_corosync_configuration">B. Sample Corosync Configuration</a></span></dt><dt><span class="appendix"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_further_reading">C. Further Reading</a></span></dt><dt><span class="appendix"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#appe-Clusters_from_Scratch-Revision_History">D. Revision History</a></span></dt><dt><span class="index"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254557660928">Index</a></span></dt></dl></div><div class="list-of-figures"><p><strong>List of Figures</strong></p><dl><dt>1.1. <a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254663664432">The Pacemaker Stack</a></dt><dt>1.2. <a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254585017680">Internal Components</a></dt><dt>1.3. <a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254584776320">Active/Passive Redundancy</a></dt><dt>1.4. <a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254584771664">Shared Failover</a></dt><dt>1.5. <a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254582846544">N to N Redundancy</a></dt></dl></div><div class="list-of-examples"><p><strong>List of Examples</strong></p><dl><dt>5.1. <a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254660465728">The last XML you’ll see in this document</a></dt></dl></div><div xml:lang="en-US" class="preface" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="pref-Clusters_from_Scratch-Preface"></a>Preface</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254577303632">1. Document Conventions</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254660520592">1.1. Typographic Conventions</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254632800992">1.2. Pull-quote Conventions</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254544989456">1.3. Notes and Warnings</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254584875696">2. We Need Feedback!</a></span></dt></dl></div><div xml:lang="en-US" class="section" lang="en-US"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="idm254577303632">
      ⁠</a>1.&nbsp;Document Conventions</h2></div></div></div><div class="para">
		This manual uses several conventions to highlight certain words and phrases and draw attention to specific pieces of information.
	</div><div class="para">
		In PDF and paper editions, this manual uses typefaces drawn from the <a href="https://fedorahosted.org/liberation-fonts/">Liberation Fonts</a> set. The Liberation Fonts set is also used in HTML editions if the set is installed on your system. If not, alternative but equivalent typefaces are displayed. Note: Red Hat Enterprise Linux 5 and later include the Liberation Fonts set by default.
	</div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="idm254660520592">
      ⁠</a>1.1.&nbsp;Typographic Conventions</h3></div></div></div><div class="para">
			Four typographic conventions are used to call attention to specific words and phrases. These conventions, and the circumstances they apply to, are as follows.
		</div><div class="para">
			<code class="literal">Mono-spaced Bold</code>
		</div><div class="para">
			Used to highlight system input, including shell commands, file names and paths. Also used to highlight keys and key combinations. For example:
		</div><div class="blockquote"><blockquote class="blockquote"><div class="para">
				To see the contents of the file <code class="filename">my_next_bestselling_novel</code> in your current working directory, enter the <code class="command">cat my_next_bestselling_novel</code> command at the shell prompt and press <span class="keycap"><strong>Enter</strong></span> to execute the command.
			</div></blockquote></div><div class="para">
			The above includes a file name, a shell command and a key, all presented in mono-spaced bold and all distinguishable thanks to context.
		</div><div class="para">
			Key combinations can be distinguished from an individual key by the plus sign that connects each part of a key combination. For example:
		</div><div class="blockquote"><blockquote class="blockquote"><div class="para">
				Press <span class="keycap"><strong>Enter</strong></span> to execute the command.
			</div><div class="para">
				Press <span class="keycap"><strong>Ctrl</strong></span>+<span class="keycap"><strong>Alt</strong></span>+<span class="keycap"><strong>F2</strong></span> to switch to a virtual terminal.
			</div></blockquote></div><div class="para">
			The first example highlights a particular key to press. The second example highlights a key combination: a set of three keys pressed simultaneously.
		</div><div class="para">
			If source code is discussed, class names, methods, functions, variable names and returned values mentioned within a paragraph will be presented as above, in <code class="literal">mono-spaced bold</code>. For example:
		</div><div class="blockquote"><blockquote class="blockquote"><div class="para">
				File-related classes include <code class="classname">filesystem</code> for file systems, <code class="classname">file</code> for files, and <code class="classname">dir</code> for directories. Each class has its own associated set of permissions.
			</div></blockquote></div><div class="para">
			<span class="application"><strong>Proportional Bold</strong></span>
		</div><div class="para">
			This denotes words or phrases encountered on a system, including application names; dialog-box text; labeled buttons; check-box and radio-button labels; menu titles and submenu titles. For example:
		</div><div class="blockquote"><blockquote class="blockquote"><div class="para">
				Choose <span class="guimenu"><strong>System</strong></span> → <span class="guisubmenu"><strong>Preferences</strong></span> → <span class="guimenuitem"><strong>Mouse</strong></span> from the main menu bar to launch <span class="application"><strong>Mouse Preferences</strong></span>. In the <span class="guilabel"><strong>Buttons</strong></span> tab, select the <span class="guilabel"><strong>Left-handed mouse</strong></span> check box and click <span class="guibutton"><strong>Close</strong></span> to switch the primary mouse button from the left to the right (making the mouse suitable for use in the left hand).
			</div><div class="para">
				To insert a special character into a <span class="application"><strong>gedit</strong></span> file, choose <span class="guimenu"><strong>Applications</strong></span> → <span class="guisubmenu"><strong>Accessories</strong></span> → <span class="guimenuitem"><strong>Character Map</strong></span> from the main menu bar. Next, choose <span class="guimenu"><strong>Search</strong></span> → <span class="guimenuitem"><strong>Find…</strong></span> from the <span class="application"><strong>Character Map</strong></span> menu bar, type the name of the character in the <span class="guilabel"><strong>Search</strong></span> field and click <span class="guibutton"><strong>Next</strong></span>. The character you sought will be highlighted in the <span class="guilabel"><strong>Character Table</strong></span>. Double-click this highlighted character to place it in the <span class="guilabel"><strong>Text to copy</strong></span> field and then click the <span class="guibutton"><strong>Copy</strong></span> button. Now switch back to your document and choose <span class="guimenu"><strong>Edit</strong></span> → <span class="guimenuitem"><strong>Paste</strong></span> from the <span class="application"><strong>gedit</strong></span> menu bar.
			</div></blockquote></div><div class="para">
			The above text includes application names; system-wide menu names and items; application-specific menu names; and buttons and text found within a GUI interface, all presented in proportional bold and all distinguishable by context.
		</div><div class="para">
			<code class="command"><em class="replaceable">Mono-spaced Bold Italic</em></code> or <span class="application"><strong><em class="replaceable">Proportional Bold Italic</em></strong></span>
		</div><div class="para">
			Whether mono-spaced bold or proportional bold, the addition of italics indicates replaceable or variable text. Italics denotes text you do not input literally or displayed text that changes depending on circumstance. For example:
		</div><div class="blockquote"><blockquote class="blockquote"><div class="para">
				To connect to a remote machine using ssh, type <code class="command">ssh <em class="replaceable">username</em>@<em class="replaceable">domain.name</em></code> at a shell prompt. If the remote machine is <code class="filename">example.com</code> and your username on that machine is john, type <code class="command">ssh john@example.com</code>.
			</div><div class="para">
				The <code class="command">mount -o remount <em class="replaceable">file-system</em></code> command remounts the named file system. For example, to remount the <code class="filename">/home</code> file system, the command is <code class="command">mount -o remount /home</code>.
			</div><div class="para">
				To see the version of a currently installed package, use the <code class="command">rpm -q <em class="replaceable">package</em></code> command. It will return a result as follows: <code class="command"><em class="replaceable">package-version-release</em></code>.
			</div></blockquote></div><div class="para">
			Note the words in bold italics above: username, domain.name, file-system, package, version and release. Each word is a placeholder, either for text you enter when issuing a command or for text displayed by the system.
		</div><div class="para">
			Aside from standard usage for presenting the title of a work, italics denotes the first use of a new and important term. For example:
		</div><div class="blockquote"><blockquote class="blockquote"><div class="para">
				Publican is a <em class="firstterm">DocBook</em> publishing system.
			</div></blockquote></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="idm254632800992">
      ⁠</a>1.2.&nbsp;Pull-quote Conventions</h3></div></div></div><div class="para">
			Terminal output and source code listings are set off visually from the surrounding text.
		</div><div class="para">
			Output sent to a terminal is set in <code class="computeroutput">mono-spaced roman</code> and presented thus:
		</div><pre class="screen">books        Desktop   documentation  drafts  mss    photos   stuff  svn
books_tests  Desktop1  downloads      images  notes  scripts  svgs</pre><div class="para">
			Source-code listings are also set in <code class="computeroutput">mono-spaced roman</code> but add syntax highlighting as follows:
		</div><pre xml:lang="en-US" class="programlisting" lang="en-US">package org.<span class="perl_Function">jboss</span>.<span class="perl_Function">book</span>.<span class="perl_Function">jca</span>.<span class="perl_Function">ex1</span>;

<span class="perl_Keyword">import</span> javax.naming.InitialContext;

<span class="perl_Keyword">public</span> <span class="perl_Keyword">class</span> ExClient
{
   <span class="perl_Keyword">public</span> <span class="perl_DataType">static</span> <span class="perl_DataType">void</span> <span class="perl_Function">main</span>(String args[]) 
       <span class="perl_Keyword">throws</span> Exception
   {
      InitialContext iniCtx = <span class="perl_Keyword">new</span> InitialContext();
      Object         ref    = iniCtx.<span class="perl_Function">lookup</span>(<span class="perl_String">"EchoBean"</span>);
      EchoHome       home   = (EchoHome) ref;
      Echo           echo   = home.<span class="perl_Function">create</span>();

      System.<span class="perl_Function">out</span>.<span class="perl_Function">println</span>(<span class="perl_String">"Created Echo"</span>);

      System.<span class="perl_Function">out</span>.<span class="perl_Function">println</span>(<span class="perl_String">"Echo.echo('Hello') = "</span> + echo.<span class="perl_Function">echo</span>(<span class="perl_String">"Hello"</span>));
   }
}</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="idm254544989456">
      ⁠</a>1.3.&nbsp;Notes and Warnings</h3></div></div></div><div class="para">
			Finally, we use three visual styles to draw attention to information that might otherwise be overlooked.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				Notes are tips, shortcuts or alternative approaches to the task at hand. Ignoring a note should have no negative consequences, but you might miss out on a trick that makes your life easier.
			</div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				Important boxes detail things that are easily missed: configuration changes that only apply to the current session, or services that need restarting before an update will apply. Ignoring a box labeled “Important” will not cause data loss but may cause irritation and frustration.
			</div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="warning"><div class="admonition_header"><p><strong>Warning</strong></p></div><div class="admonition"><div class="para">
				Warnings should not be ignored. Ignoring warnings will most likely cause data loss.
			</div></div></div></div></div><div xml:lang="en-US" class="section" lang="en-US"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="idm254584875696">
      ⁠</a>2.&nbsp;We Need Feedback!</h2></div></div></div><a id="idm254660616176" class="indexterm"></a><div class="para">
		If you find a typographical error in this manual, or if you have thought of a way to make this manual better, we would love to hear from you! Please submit a report in Bugzilla<a id="idm254660614288">
      ⁠</a><a xmlns:d="http://docbook.org/ns/docbook" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254660614288" class="footnote"><sup class="footnote">[2]</sup></a> against the product <span class="application"><strong>Pacemaker.</strong></span>
	</div><div class="para">
		When submitting a bug report, be sure to mention the manual's identifier: <em class="citetitle">Clusters_from_Scratch</em>
	</div><div class="para">
		If you have a suggestion for improving the documentation, try to be as specific as possible when describing it. If you have found an error, please include the section number and some of the surrounding text so we can find it easily.
	</div></div><div class="footnotes"><br><hr width="100" align="left"><div id="ftn.idm254660614288" class="footnote"><div class="para"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254660614288" class="para"><sup class="para">[2] </sup></a>
			<a href="http://bugs.clusterlabs.org/">http://bugs.clusterlabs.org</a>
		</div></div></div></div><div xml:lang="en-US" class="chapter" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="idm254583786528">
      ⁠</a>Chapter&nbsp;1.&nbsp;Read-Me-First</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_the_scope_of_this_document">1.1. The Scope of this Document</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_what_is_pacemaker">1.2. What Is Pacemaker?</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_pacemaker_architecture">1.3. Pacemaker Architecture</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_internal_components">1.3.1. Internal Components</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_types_of_pacemaker_clusters">1.4. Types of Pacemaker Clusters</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_the_scope_of_this_document">
      ⁠</a>1.1.&nbsp;The Scope of this Document</h2></div></div></div><div class="para">
			Computer clusters can be used to provide highly available services or resources. The redundancy of multiple machines is used to guard against failures of many types.
		</div><div class="para">
			This document will walk through the installation and setup of simple clusters using the Fedora distribution, version 20.
		</div><div class="para">
			The clusters described here will use Pacemaker and Corosync to provide resource management and messaging. Required packages and modifications to their configuration files are described along with the use of the Pacemaker command line tool for generating the XML used for cluster control.
		</div><div class="para">
			Pacemaker is a central component and provides the resource management required in these systems. This management includes detecting and recovering from the failure of various nodes, resources and services under its control.
		</div><div class="para">
			When more in depth information is required and for real world usage, please refer to the <a href="http://www.clusterlabs.org/doc/">Pacemaker Explained</a> manual.
		</div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_what_is_pacemaker">
      ⁠</a>1.2.&nbsp;What Is Pacemaker?</h2></div></div></div><div class="para">
			Pacemaker is a cluster resource manager.
		</div><div class="para">
			It achieves maximum availability for your cluster services (aka. resources) by detecting and recovering from node and resource-level failures by making use of the messaging and membership capabilities provided by your preferred cluster infrastructure (either <a href="http://www.corosync.org/">Corosync</a> or <a href="http://linux-ha.org/wiki/Heartbeat">Heartbeat</a>).
		</div><div class="para">
			Pacemaker’s key features include:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Detection and recovery of node and service-level failures
				</div></li><li class="listitem"><div class="para">
					Storage agnostic, no requirement for shared storage
				</div></li><li class="listitem"><div class="para">
					Resource agnostic, anything that can be scripted can be clustered
				</div></li><li class="listitem"><div class="para">
					Supports STONITH for ensuring data integrity
				</div></li><li class="listitem"><div class="para">
					Supports large and small clusters
				</div></li><li class="listitem"><div class="para">
					Supports both quorate and resource driven clusters
				</div></li><li class="listitem"><div class="para">
					Supports practically any redundancy configuration
				</div></li><li class="listitem"><div class="para">
					Automatically replicated configuration that can be updated from any node
				</div></li><li class="listitem"><div class="para">
					Ability to specify cluster-wide service ordering, colocation and anti-colocation
				</div></li><li class="listitem"><div class="para">
					Support for advanced service types
				</div><div class="itemizedlist"><ul><li class="listitem"><div class="para">
							Clones: for services which need to be active on multiple nodes
						</div></li><li class="listitem"><div class="para">
							Multi-state: for services with multiple modes (eg. master/slave, primary/secondary)
						</div></li></ul></div></li><li class="listitem"><div class="para">
					Unified, scriptable, cluster management tools.
				</div></li></ul></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_pacemaker_architecture">
      ⁠</a>1.3.&nbsp;Pacemaker Architecture</h2></div></div></div><div class="para">
			At the highest level, the cluster is made up of three pieces:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Non-cluster aware components. These pieces include the resources themselves, scripts that start, stop and monitor them, and also a local daemon that masks the differences between the different standards these scripts implement.
				</div></li><li class="listitem"><div class="para">
					Resource management. Pacemaker provides the brain that processes and reacts to events regarding the cluster. These events include nodes joining or leaving the cluster; resource events caused by failures, maintenance, scheduled activities; and other administrative actions. Pacemaker will compute the ideal state of the cluster and plot a path to achieve it after any of these events. This may include moving resources, stopping nodes and even forcing them offline with remote power switches.
				</div></li><li class="listitem"><div class="para">
					Low level infrastructure. Projects like Corosync, CMAN and Heartbeat provide reliable messaging, membership and quorum information about the cluster.
				</div></li></ul></div><div class="para">
			When combined with Corosync, Pacemaker also supports popular open source cluster filesystems. footnote:[ Even though Pacemaker also supports Heartbeat, the filesystems need to use the stack for messaging and membership and Corosync seems to be what they’re standardizing on.
		</div><div class="para">
			Technically it would be possible for them to support Heartbeat as well, however there seems little interest in this. ]
		</div><div class="para">
			Due to past standardization within the cluster filesystem community, they make use of a common distributed lock manager which makes use of Corosync for its messaging and membership capabilities (which nodes are up/down) and Pacemaker for fencing services.
		</div><div class="figure"><a id="idm254663664432">
      ⁠</a><div class="figure-contents"><div class="mediaobject" align="center"><img src="./Clusters from Scratch_files/pcmk-stack.png" align="middle" width="354.330708661417" height="265.748031496063" alt="The Pacemaker stack"></div></div><p class="title"><strong>Figure&nbsp;1.1.&nbsp;The Pacemaker Stack</strong></p></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_internal_components">
      ⁠</a>1.3.1.&nbsp;Internal Components</h3></div></div></div><div class="para">
				Pacemaker itself is composed of five key components:
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						CIB (aka. Cluster Information Base)
					</div></li><li class="listitem"><div class="para">
						CRMd (aka. Cluster Resource Management daemon)
					</div></li><li class="listitem"><div class="para">
						LRMd (aka. Local Resource Management daemon)
					</div></li><li class="listitem"><div class="para">
						PEngine (aka. PE or Policy Engine)
					</div></li><li class="listitem"><div class="para">
						STONITHd
					</div></li></ul></div><div class="figure"><a id="idm254585017680">
      ⁠</a><div class="figure-contents"><div class="mediaobject" align="center"><img src="./Clusters from Scratch_files/pcmk-internals.png" align="middle" width="65%" alt="Subsystems of a Pacemaker cluster"></div></div><p class="title"><strong>Figure&nbsp;1.2.&nbsp;Internal Components</strong></p></div><div class="para">
				The CIB uses XML to represent both the cluster’s configuration and current state of all resources in the cluster. The contents of the CIB are automatically kept in sync across the entire cluster and are used by the PEngine to compute the ideal state of the cluster and how it should be achieved.
			</div><div class="para">
				This list of instructions is then fed to the DC (Designated Controller). Pacemaker centralizes all cluster decision making by electing one of the CRMd instances to act as a master. Should the elected CRMd process, or the node it is on, fail… a new one is quickly established.
			</div><div class="para">
				The DC carries out the PEngine’s instructions in the required order by passing them to either the LRMd (Local Resource Management daemon) or CRMd peers on other nodes via the cluster messaging infrastructure (which in turn passes them on to their LRMd process).
			</div><div class="para">
				The peer nodes all report the results of their operations back to the DC and, based on the expected and actual results, will either execute any actions that needed to wait for the previous one to complete, or abort processing and ask the PEngine to recalculate the ideal cluster state based on the unexpected results.
			</div><div class="para">
				In some cases, it may be necessary to power off nodes in order to protect shared data or complete resource recovery. For this Pacemaker comes with STONITHd.
			</div><div class="para">
				STONITH is an acronym for Shoot-The-Other-Node-In-The-Head and is usually implemented with a remote power switch.
			</div><div class="para">
				In Pacemaker, STONITH devices are modeled as resources (and configured in the CIB) to enable them to be easily monitored for failure, however STONITHd takes care of understanding the STONITH topology such that its clients simply request a node be fenced and it does the rest.
			</div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_types_of_pacemaker_clusters">
      ⁠</a>1.4.&nbsp;Types of Pacemaker Clusters</h2></div></div></div><div class="para">
			Pacemaker makes no assumptions about your environment, this allows it to support practically any <a href="http://en.wikipedia.org/wiki/High-availability_cluster#Node_configurations">redundancy configuration</a> including Active/Active, Active/Passive, N+1, N+M, N-to-1 and N-to-N.
		</div><div class="figure"><a id="idm254584776320">
      ⁠</a><div class="figure-contents"><div class="mediaobject" align="center"><img src="./Clusters from Scratch_files/pcmk-active-passive.png" align="middle" width="354.330708661417" height="265.748031496063" alt="Active/Passive Redundancy"></div></div><p class="title"><strong>Figure&nbsp;1.3.&nbsp;Active/Passive Redundancy</strong></p></div><div class="para">
			Two-node Active/Passive clusters using Pacemaker and DRBD are a cost-effective solution for many High Availability situations.
		</div><div class="figure"><a id="idm254584771664">
      ⁠</a><div class="figure-contents"><div class="mediaobject" align="center"><img src="./Clusters from Scratch_files/pcmk-shared-failover.png" align="middle" width="354.330708661417" height="265.748031496063" alt="Shared Failover"></div></div><p class="title"><strong>Figure&nbsp;1.4.&nbsp;Shared Failover</strong></p></div><div class="para">
			By supporting many nodes, Pacemaker can dramatically reduce hardware costs by allowing several active/passive clusters to be combined and share a common backup node
		</div><div class="figure"><a id="idm254582846544">
      ⁠</a><div class="figure-contents"><div class="mediaobject" align="center"><img src="./Clusters from Scratch_files/pcmk-active-active.png" align="middle" width="354.330708661417" height="265.748031496063" alt="N to N Redundancy"></div></div><p class="title"><strong>Figure&nbsp;1.5.&nbsp;N to N Redundancy</strong></p></div><div class="para">
			When shared storage is available, every node can potentially be used for failover. Pacemaker can even run multiple copies of services to spread out the workload.
		</div></div></div><div xml:lang="en-US" class="chapter" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="idm254648951440">
      ⁠</a>Chapter&nbsp;2.&nbsp;Installation</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_os_installation">2.1. OS Installation</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_post_installation_tasks">2.2. Post Installation Tasks</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_networking">2.2.1. Networking</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_leaving_the_console">2.2.2. Leaving the Console</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_security_shortcuts">2.2.3. Security Shortcuts</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_short_node_names">2.2.4. Short Node Names</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_before_you_continue">2.3. Before You Continue</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_finalize_networking">2.3.1. Finalize Networking</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configure_ssh">2.3.2. Configure SSH</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_cluster_software_installation">2.4. Cluster Software Installation</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_install_the_cluster_software">2.4.1. Install the Cluster Software</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_install_the_cluster_management_software">2.4.2. Install the Cluster Management Software</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_setup">2.5. Setup</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_enable_pcs_daemon">2.5.1. Enable pcs Daemon</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_notes_on_multicast_address_assignment">2.5.2. Notes on Multicast Address Assignment</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configuring_corosync">2.5.3. Configuring Corosync</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_os_installation">
      ⁠</a>2.1.&nbsp;OS Installation</h2></div></div></div><div class="para">
			Detailed instructions for installing Fedora are available at <a href="http://docs.fedoraproject.org/en-US/Fedora/20/html/Installation_Guide/">http://docs.fedoraproject.org/en-US/Fedora/20/html/Installation_Guide/</a> in a number of languages. The abbreviated version is as follows…
		</div><div class="para">
			Point your browser to <a href="http://fedoraproject.org/en/get-fedora-all">http://fedoraproject.org/en/get-fedora-all</a>, locate the <code class="literal">Install Media</code> section and download the install DVD that matches your hardware.
		</div><div class="para">
			Burn the disk image to a DVD <a id="idm254583041760">
      ⁠</a><a xmlns:d="http://docbook.org/ns/docbook" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254583041760" class="footnote"><sup class="footnote">[3]</sup></a> and boot from it, or use the image to boot a virtual machine.
		</div><div class="para">
			After clicking through the welcome screen, select your language, keyboard layout <a id="idm254560967936">
      ⁠</a><a xmlns:d="http://docbook.org/ns/docbook" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254560967936" class="footnote"><sup class="footnote">[4]</sup></a>
		</div><div class="para">
			At this point you get a chance to tweak the default installation options.
		</div><div class="para">
			In the <code class="literal">Network Configuration</code> section you’ll want to:
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					Assign your machine a host name I happen to control the clusterlabs.org domain name, so I will use that here.
				</div></li><li class="listitem"><div class="para">
					Assign a fixed IP address
				</div></li></ul></div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				Do not accept the default network settings. Cluster machines should never obtain an IP address via DHCP.
			</div><div class="para">
				If you miss this step, this can easily be configured after installation. You will have to navigate to <code class="literal">system settings</code> and select <code class="literal">network</code>. From there you can select what device to configure.
			</div></div></div><div class="para">
			In the <code class="literal">Software Selection</code> section (try saying that 10 times quickly), choose <code class="literal">Minimal Install</code> so that we see everything that gets installed. Don’t enable updates yet, we’ll do that (and install any extra software we need) later.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				By default Fedora uses LVM for partitioning which allows us to dynamically change the amount of space allocated to a given partition.
			</div><div class="para">
				However, by default it also allocates all free space to the <code class="literal">/</code> (aka. <code class="literal">root</code>) partition which cannot be dynamically <span class="emphasis"><em>reduced</em></span> in size (dynamic increases are fine by-the-way).
			</div><div class="para">
				So if you plan on following the DRBD or GFS2 portions of this guide, you should reserve at least 1Gb of space on each machine from which to create a shared volume. To do so, enter the <code class="literal">Installation Destination</code> section where you are be given an opportunity to reduce the size of the <code class="literal">root</code> partition (after chosing which hard drive you wish to install to).
			</div></div></div><div class="para">
			It is highly recommended to enable NTP on your cluster nodes. Doing so ensures all nodes agree on the current time and makes reading log files significantly easier. You can do this in the <code class="literal">Date &amp; Time</code> section. <a id="idm254568859872">
      ⁠</a><a xmlns:d="http://docbook.org/ns/docbook" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254568859872" class="footnote"><sup class="footnote">[5]</sup></a>
		</div><div class="para">
			Once the node reboots, you’ll see a (possibly mangled) login prompt on the console. Login using <code class="literal">root</code> and the password you created earlier.
		</div><div class="informalfigure"><div class="mediaobject" align="center"><img src="./Clusters from Scratch_files/Console.png" align="middle" width="65%" alt="Initial Console"></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				From here on in we’re going to be working exclusively from the terminal.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_post_installation_tasks">
      ⁠</a>2.2.&nbsp;Post Installation Tasks</h2></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_networking">
      ⁠</a>2.2.1.&nbsp;Networking</h3></div></div></div><div class="para">
				Check the machine has the static IP address you configured earlier
			</div><pre class="programlisting"><span class="perl_Others"># ip addr</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Float">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="perl_Float">16436</span> qdisc noqueue state UNKNOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="perl_Float">127.0</span>.0.<span class="perl_Float">1</span>/<span class="perl_Float">8</span> scope host lo
    inet6 ::<span class="perl_Float">1</span>/<span class="perl_Float">128</span> scope host
       valid_lft forever preferred_lft forever
<span class="perl_Float">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="perl_Float">1500</span> qdisc pfifo_fast state UP qlen <span class="perl_Float">1000</span>
    link/ether <span class="perl_Float">52</span>:<span class="perl_Float">54</span>:00:d7:d6:08 brd ff:ff:ff:ff:ff:ff
    inet <span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span>/<span class="perl_Float">24</span> brd <span class="perl_Float">192.168</span>.<span class="perl_Float">122.255</span> scope global eth0
    inet6 fe80::<span class="perl_Float">5054</span>:ff:fed7:d608/<span class="perl_Float">64</span> scope link
       valid_lft forever preferred_lft forever</pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					If you ever need to change the node’s IP address from the command line follow these instructions:
				</div><pre class="literallayout"># manually edit /etc/sysconfig/network-scripts/ifcfg-${device}
# nmcli dev disconnect ${device}
# nmcli con reload ${device}
# nmcli con up ${device}</pre><div class="para">
					This makes <code class="literal">NetworkManager</code> aware that a change was made on the config file.
				</div></div></div><div class="para">
				Next, check the routes are ok:
			</div><pre class="programlisting">[root@pcmk-<span class="perl_Float">1</span> ~]# ip route
<span class="perl_Keyword">default</span> via <span class="perl_Float">192.168</span>.<span class="perl_Float">122.1</span> dev eth0
<span class="perl_Float">192.168</span>.<span class="perl_Float">122.0</span>/<span class="perl_Float">24</span> dev eth0  proto kernel  scope link  src <span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span></pre><div class="para">
				If there is no line beginning with <code class="literal">default via</code>, then you may need to add a line such as
			</div><pre class="programlisting"><span class="perl_Others">GATEWAY=</span>192.168.122.1</pre><div class="para">
				to <span class="emphasis"><em>/etc/sysconfig/network</em></span> and restart the network.
			</div><div class="para">
				Now check for connectivity to the outside world. Start small by testing if we can read the gateway we configured.
			</div><pre class="programlisting"><span class="perl_Others"># ping -c 1 192.168.122.1</span><span class="perl_Others"></span>
<span class="perl_Others"></span>PING <span class="perl_Float">192.168</span>.<span class="perl_Float">122.1</span> (<span class="perl_Float">192.168</span>.<span class="perl_Float">122.1</span>) <span class="perl_Float">56</span>(<span class="perl_Float">84</span>) bytes of data.
<span class="perl_Float">64</span> bytes from <span class="perl_Float">192.168</span>.<span class="perl_Float">122.1</span>: icmp_req=<span class="perl_Float">1</span> ttl=<span class="perl_Float">64</span> time=0.<span class="perl_Float">249</span> ms

 --- <span class="perl_Float">192.168</span>.<span class="perl_Float">122.1</span> ping statistics ---
<span class="perl_Float">1</span> packets transmitted, <span class="perl_Float">1</span> received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.<span class="perl_Float">249</span>/0.<span class="perl_Float">249</span>/0.<span class="perl_Float">249</span>/0.000 ms</pre><div class="para">
				Now try something external, choose a location you know will be available.
			</div><pre class="programlisting"><span class="perl_Others"># ping -c 1 www.google.com</span><span class="perl_Others"></span>
<span class="perl_Others"></span>PING www.l.google.com (<span class="perl_Float">173.194</span>.<span class="perl_Float">72.106</span>) <span class="perl_Float">56</span>(<span class="perl_Float">84</span>) bytes of data.
<span class="perl_Float">64</span> bytes from tf-in-f106.<span class="perl_Float">1e100</span>.net (<span class="perl_Float">173.194</span>.<span class="perl_Float">72.106</span>): icmp_req=<span class="perl_Float">1</span> ttl=41 time=<span class="perl_Float">167</span> ms

 --- www.l.google.com ping statistics ---
<span class="perl_Float">1</span> packets transmitted, <span class="perl_Float">1</span> received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = <span class="perl_Float">167.618</span>/<span class="perl_Float">167.618</span>/<span class="perl_Float">167.618</span>/0.000 ms</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_leaving_the_console">
      ⁠</a>2.2.2.&nbsp;Leaving the Console</h3></div></div></div><div class="para">
				The console isn’t a very friendly place to work from, we will now switch to accessing the machine remotely via SSH where we can use copy&amp;paste etc.
			</div><div class="para">
				First we check we can see the newly installed at all:
			</div><pre class="programlisting">beekhof@f16 ~ # ping -c <span class="perl_Float">1</span> <span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span>
PING <span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span> (<span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span>) <span class="perl_Float">56</span>(<span class="perl_Float">84</span>) bytes of data.
<span class="perl_Float">64</span> bytes from <span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span>: icmp_req=<span class="perl_Float">1</span> ttl=<span class="perl_Float">64</span> time=<span class="perl_Float">1.01</span> ms

--- <span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span> ping statistics ---
<span class="perl_Float">1</span> packets transmitted, <span class="perl_Float">1</span> received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = <span class="perl_Float">1.012</span>/<span class="perl_Float">1.012</span>/<span class="perl_Float">1.012</span>/0.000 ms</pre><div class="para">
				Next we login via SSH
			</div><pre class="programlisting">beekhof@f16 ~ # ssh -l root <span class="perl_Float">192.168</span>.<span class="perl_Float">122.11</span>
root@192.<span class="perl_Float">168.122</span>.<span class="perl_Float">11</span>'s password:
Last login: Fri Mar <span class="perl_Float">30</span> <span class="perl_Float">19</span>:41:<span class="perl_Float">19</span> <span class="perl_Float">2012</span> from <span class="perl_Float">192.168</span>.<span class="perl_Float">122.1</span>
[root@pcmk-<span class="perl_Float">1</span> ~]#</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_security_shortcuts">
      ⁠</a>2.2.3.&nbsp;Security Shortcuts</h3></div></div></div><div class="para">
				To simplify this guide and focus on the aspects directly connected to clustering, we will now disable the machine’s firewall and SELinux installation.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="warning"><div class="admonition_header"><p><strong>Warning</strong></p></div><div class="admonition"><div class="para">
					Both of these actions create significant security issues and should not be performed on machines that will be exposed to the outside world.
				</div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><pre class="literallayout">TODO: Create an Appendix that deals with (at least) re-enabling the firewall.</pre></div></div><pre class="programlisting"><span class="perl_Others"># setenforce 0</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># sed -i.bak "s/SELINUX=enforcing/SELINUX=permissive/g" /etc/selinux/config</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># systemctl disable firewalld.service</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># systemctl stop firewalld.service</span></pre><div class="para">
				or (on older Fedora)
			</div><pre class="programlisting"><span class="perl_Others"># setenforce 0</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># sed -i.bak "s/SELINUX=enforcing/SELINUX=permissive/g" /etc/selinux/config</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># systemctl disable iptables.service</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># rm '/etc/systemd/system/basic.target.wants/iptables.service'</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># systemctl stop iptables.service</span></pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_short_node_names">
      ⁠</a>2.2.4.&nbsp;Short Node Names</h3></div></div></div><div class="para">
				During installation, we filled in the machine’s fully qualified domain name (FQDN) which can be rather long when it appears in cluster logs and status output. See for yourself how the machine identifies itself: <a id="idm254578401248" class="indexterm"></a><a id="idm254578400448" class="indexterm"></a>
			</div><pre class="programlisting"><span class="perl_Others"># uname -n</span><span class="perl_Others"></span>
<span class="perl_Others"></span>pcmk-<span class="perl_Float">1.</span>clusterlabs.org
<span class="perl_Others"># dnsdomainname</span><span class="perl_Others"></span>
<span class="perl_Others"></span>clusterlabs.org</pre><div class="para">
				<a id="idm254578398416" class="indexterm"></a><a id="idm254578397616" class="indexterm"></a>
			</div><div class="para">
				The output from the second command is fine, but we really don’t need the domain name included in the basic host details. To address this, we need to use the <code class="literal">hostnamectl</code> tool to strip off the domain name.
			</div><pre class="programlisting"><span class="perl_Others"># hostnamectl set-hostname $(uname -n | sed s/\\..*//)'</span></pre><div class="para">
				<a id="idm254567421408" class="indexterm"></a><a id="idm254567420640" class="indexterm"></a>
			</div><div class="para">
				Now check the machine is using the correct names
			</div><pre class="programlisting"><span class="perl_Others"># uname -n</span><span class="perl_Others"></span>
<span class="perl_Others"></span>pcmk-<span class="perl_Float">1</span>
<span class="perl_Others"># dnsdomainname</span><span class="perl_Others"></span>
<span class="perl_Others"></span>clusterlabs.org</pre><div class="para">
				If it concerns you that the shell prompt has not been updated, simply log out and back in again.
			</div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_before_you_continue">
      ⁠</a>2.3.&nbsp;Before You Continue</h2></div></div></div><div class="para">
			Repeat the Installation steps so far, so that you have two Fedora nodes ready to have the cluster software installed.
		</div><div class="para">
			For the purposes of this document, the additional node is called pcmk-2 with address 192.168.122.102.
		</div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_finalize_networking">
      ⁠</a>2.3.1.&nbsp;Finalize Networking</h3></div></div></div><div class="para">
				Confirm that you can communicate between the two new nodes:
			</div><pre class="programlisting"><span class="perl_Others"># ping -c 3 192.168.122.102</span><span class="perl_Others"></span>
<span class="perl_Others"></span>PING <span class="perl_Float">192.168</span>.<span class="perl_Float">122.102</span> (<span class="perl_Float">192.168</span>.<span class="perl_Float">122.102</span>) <span class="perl_Float">56</span>(<span class="perl_Float">84</span>) bytes of data.
<span class="perl_Float">64</span> bytes from <span class="perl_Float">192.168</span>.<span class="perl_Float">122.102</span>: icmp_seq=<span class="perl_Float">1</span> ttl=<span class="perl_Float">64</span> time=0.<span class="perl_Float">343</span> ms
<span class="perl_Float">64</span> bytes from <span class="perl_Float">192.168</span>.<span class="perl_Float">122.102</span>: icmp_seq=<span class="perl_Float">2</span> ttl=<span class="perl_Float">64</span> time=0.402 ms
<span class="perl_Float">64</span> bytes from <span class="perl_Float">192.168</span>.<span class="perl_Float">122.102</span>: icmp_seq=<span class="perl_Float">3</span> ttl=<span class="perl_Float">64</span> time=0.<span class="perl_Float">558</span> ms

--- <span class="perl_Float">192.168</span>.<span class="perl_Float">122.102</span> ping statistics ---
<span class="perl_Float">3</span> packets transmitted, <span class="perl_Float">3</span> received, 0% packet loss, time <span class="perl_Float">2000</span>ms
rtt min/avg/max/mdev = 0.<span class="perl_Float">343</span>/0.434/0.<span class="perl_Float">558</span>/0.092 ms</pre><div class="para">
				Now we need to make sure we can communicate with the machines by their name. If you have a DNS server, add additional entries for the two machines. Otherwise, you’ll need to add the machines to <span class="emphasis"><em>/etc/hosts</em></span> . Below are the entries for my cluster nodes:
			</div><pre class="programlisting"><span class="perl_Others"># grep pcmk /etc/hosts</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span> pcmk-<span class="perl_Float">1.</span>clusterlabs.org pcmk-<span class="perl_Float">1</span>
<span class="perl_Float">192.168</span>.<span class="perl_Float">122.102</span> pcmk-<span class="perl_Float">2.</span>clusterlabs.org pcmk-<span class="perl_Float">2</span></pre><div class="para">
				We can now verify the setup by again using ping:
			</div><pre class="programlisting"><span class="perl_Others"># ping -c 3 pcmk-2</span><span class="perl_Others"></span>
<span class="perl_Others"></span>PING pcmk-<span class="perl_Float">2.</span>clusterlabs.org (<span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span>) <span class="perl_Float">56</span>(<span class="perl_Float">84</span>) bytes of data.
<span class="perl_Float">64</span> bytes from pcmk-<span class="perl_Float">1.</span>clusterlabs.org (<span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span>): icmp_seq=<span class="perl_Float">1</span> ttl=<span class="perl_Float">64</span> time=0.<span class="perl_Float">164</span> ms
<span class="perl_Float">64</span> bytes from pcmk-<span class="perl_Float">1.</span>clusterlabs.org (<span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span>): icmp_seq=<span class="perl_Float">2</span> ttl=<span class="perl_Float">64</span> time=0.475 ms
<span class="perl_Float">64</span> bytes from pcmk-<span class="perl_Float">1.</span>clusterlabs.org (<span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span>): icmp_seq=<span class="perl_Float">3</span> ttl=<span class="perl_Float">64</span> time=0.<span class="perl_Float">186</span> ms

--- pcmk-<span class="perl_Float">2.</span>clusterlabs.org ping statistics ---
<span class="perl_Float">3</span> packets transmitted, <span class="perl_Float">3</span> received, 0% packet loss, time <span class="perl_Float">2001</span>ms
rtt min/avg/max/mdev = 0.<span class="perl_Float">164</span>/0.<span class="perl_Float">275</span>/0.475/0.<span class="perl_Float">141</span> ms</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_configure_ssh">
      ⁠</a>2.3.2.&nbsp;Configure SSH</h3></div></div></div><div class="para">
				SSH is a convenient and secure way to copy files and perform commands remotely. For the purposes of this guide, we will create a key without a password (using the -N option) so that we can perform remote actions without being prompted.
			</div><div class="para">
				<a id="idm254660934560" class="indexterm"></a>
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="warning"><div class="admonition_header"><p><strong>Warning</strong></p></div><div class="admonition"><div class="para">
					Unprotected SSH keys, those without a password, are not recommended for servers exposed to the outside world. We use them here only to simplify the demo.
				</div></div></div><div class="para">
				Create a new key and allow anyone with that key to log in:
			</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Creating and Activating a new SSH Key</div>
					
<pre class="programlisting"><span class="perl_Others"># ssh-keygen -t dsa -f ~/.ssh/id_dsa -N ""</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Generating public/private dsa key pair.
Your identification has been saved in /root/.ssh/id_dsa.
Your public key has been saved in /root/.ssh/id_dsa.pub.
The key fingerprint is:
<span class="perl_Float">91</span>:09:<span class="perl_Float">5</span>c:<span class="perl_Float">82</span>:<span class="perl_Float">5</span>a:<span class="perl_Float">6</span>a:<span class="perl_Float">50</span>:08:4e:b2:0c:<span class="perl_Float">62</span>:de:cc:<span class="perl_Float">74</span>:44 root@pcmk-<span class="perl_Float">1.</span>clusterlabs.org

The key's randomart image is:
+--[ DSA <span class="perl_Float">1024</span>]----+
|==.ooEo..        |
|X O + .o o       |
| * A    +        |
|  +      .       |
| .      S        |
|                 |
|                 |
|                 |
|                 |
+-----------------+

<span class="perl_Others"># cp .ssh/id_dsa.pub .ssh/authorized_keys</span></pre>
				</div><div class="para">
				<a id="idm254660928960" class="indexterm"></a>
			</div><div class="para">
				Install the key on the other nodes and test that you can now run commands remotely, without being prompted
			</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Installing the SSH Key on Another Host</div>
					
<pre class="programlisting"><span class="perl_Others"># scp -r .ssh pcmk-2:</span><span class="perl_Others"></span>
<span class="perl_Others"></span>The authenticity of host 'pcmk-<span class="perl_Float">2</span> (<span class="perl_Float">192.168</span>.<span class="perl_Float">122.102</span>)' can't be established.
RSA key fingerprint is b1:<span class="perl_Float">2</span>b:<span class="perl_Float">55</span>:<span class="perl_Float">93</span>:f1:d9:<span class="perl_Float">52</span>:<span class="perl_Float">2</span>b:0f:f2:<span class="perl_Float">8</span>a:4e:ae:c6:<span class="perl_Float">7</span>c:<span class="perl_Float">9</span>a.
Are you sure you want to <span class="perl_Keyword">continue</span> connecting (yes/no)? yes
Warning: Permanently added 'pcmk-<span class="perl_Float">2</span>,<span class="perl_Float">192.168</span>.<span class="perl_Float">122.102</span>' (RSA) to the list of known hosts.root@pcmk-<span class="perl_Float">2</span>'s password:
id_dsa.pub                           <span class="perl_Float">100</span>%  <span class="perl_Float">616</span>     0.<span class="perl_Float">6</span>KB/s   00:00
id_dsa                               <span class="perl_Float">100</span>%  <span class="perl_Float">672</span>     0.<span class="perl_Float">7</span>KB/s   00:00
known_hosts                          <span class="perl_Float">100</span>%  400     0.4KB/s   00:00
authorized_keys                      <span class="perl_Float">100</span>%  <span class="perl_Float">616</span>     0.<span class="perl_Float">6</span>KB/s   00:00
<span class="perl_Others"># ssh pcmk-2 -- uname -n</span><span class="perl_Others"></span>
<span class="perl_Others"></span>pcmk-<span class="perl_Float">2</span>
<span class="perl_Others">#</span></pre>
				</div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_cluster_software_installation">
      ⁠</a>2.4.&nbsp;Cluster Software Installation</h2></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_install_the_cluster_software">
      ⁠</a>2.4.1.&nbsp;Install the Cluster Software</h3></div></div></div><div class="para">
				Since version 12, Fedora comes with recent versions of everything you need, so simply fire up a shell on all your nodes and run:
			</div><pre class="programlisting">[ALL] # yum install -y pacemaker pcs</pre><div class="para">
				Now install the cluster software on the second node.
			</div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_install_the_cluster_management_software">
      ⁠</a>2.4.2.&nbsp;Install the Cluster Management Software</h3></div></div></div><div class="para">
				The pcs cli command coupled with the pcs daemon creates a cluster management system capable of managing all aspects of the cluster stack across all nodes from a single location.
			</div><pre class="programlisting">[ALL] # yum install -y pcs</pre><div class="para">
				Make sure to install the pcs packages on both nodes.
			</div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_setup">
      ⁠</a>2.5.&nbsp;Setup</h2></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_enable_pcs_daemon">
      ⁠</a>2.5.1.&nbsp;Enable pcs Daemon</h3></div></div></div><div class="para">
				Before the cluster can be configured, the pcs daemon must be started and enabled to boot on startup on each node. This daemon works with the pcs cli command to manage syncing the corosync configuration across all the nodes in the cluster.
			</div><div class="para">
				Start and enable the daemon by issuing the following commands on each node.
			</div><pre class="programlisting"><span class="perl_Others"># systemctl start pcsd.service</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># systemctl enable pcsd.service</span></pre><div class="para">
				Now we need a way for <code class="literal">pcs</code> to talk to itself on other nodes in the cluster. This is necessary in order to perform tasks such as syncing the corosync config, or starting/stopping the cluster on remote nodes
			</div><div class="para">
				While <code class="literal">pcs</code> can be used locally without setting up these user accounts, this tutorial will make use of these remote access commands, so we will set a password for the <span class="emphasis"><em>hacluster</em></span> user. Its probably best if password is consistent across all the nodes.
			</div><div class="para">
				As <span class="emphasis"><em>root</em></span>, run:
			</div><pre class="programlisting"><span class="perl_Others"># passwd hacluster</span><span class="perl_Others"></span>
<span class="perl_Others"></span>password:</pre><div class="para">
				Alternatively, to script this process or set the password on a different machine to the one you’re logged into, you can use the <code class="literal">--stdin</code> option for <code class="literal">passwd</code>:
			</div><pre class="programlisting"><span class="perl_Others"># ssh pcmk-2 -- 'echo redhat1 | passwd --stdin hacluster'</span></pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_notes_on_multicast_address_assignment">
      ⁠</a>2.5.2.&nbsp;Notes on Multicast Address Assignment</h3></div></div></div><div class="para">
				There are several subtle points that often deserve consideration when choosing/assigning multicast addresses for corosync. <a id="idm254660904336">
      ⁠</a><a xmlns:d="http://docbook.org/ns/docbook" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254660904336" class="footnote"><sup class="footnote">[6]</sup></a>
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol class="arabic"><li class="listitem"><div class="para">
						Avoid <span class="emphasis"><em>224.0.0.x</em></span>
					</div><div class="para">
						Traffic to addresses of the form <span class="emphasis"><em>224.0.0.x</em></span> is often flooded to all switch ports. This address range is reserved for link-local uses. Many routing protocols assume that all traffic within this range will be received by all routers on the network. Hence (at least all Cisco) switches flood traffic within this range. The flooding behavior overrides the normal selective forwarding behavior of a multicast-aware switch (e.g. IGMP snooping, CGMP, etc.).
					</div></li><li class="listitem"><div class="para">
						Watch for <span class="emphasis"><em>32:1</em></span> overlap
					</div><div class="para">
						32 non-contiguous IP multicast addresses are mapped onto each Ethernet multicast address. A receiver that joins a single IP multicast group implicitly joins 31 others due to this overlap. Of course, filtering in the operating system discards undesired multicast traffic from applications, but NIC bandwidth and CPU resources are nonetheless consumed discarding it. The overlap occurs in the 5 high-order bits, so it’s best to use the 23 low-order bits to make distinct multicast streams unique. For example, IP multicast addresses in the range <span class="emphasis"><em>239.0.0.0</em></span> to <span class="emphasis"><em>239.127.255.255</em></span> all map to unique Ethernet multicast addresses. However, IP multicast address <span class="emphasis"><em>239.128.0.0</em></span> maps to the same Ethernet multicast address as <span class="emphasis"><em>239.0.0.0</em></span>, <span class="emphasis"><em>239.128.0.1</em></span> maps to the same Ethernet multicast address as <span class="emphasis"><em>239.0.0.1</em></span>, etc.
					</div></li><li class="listitem"><div class="para">
						Avoid <span class="emphasis"><em>x.0.0.y</em></span> and <span class="emphasis"><em>x.128.0.y</em></span>
					</div><div class="para">
						Combining the above two considerations, it’s best to avoid using IP multicast addresses of the form <span class="emphasis"><em>x.0.0.y</em></span> and <span class="emphasis"><em>x.128.0.y</em></span> since they all map onto the range of Ethernet multicast addresses that are flooded to all switch ports.
					</div></li><li class="listitem"><div class="para">
						Watch for address assignment conflicts
					</div><div class="para">
						<a href="http://www.iana.org/">IANA</a> administers <a href="http://www.iana.org/assignments/multicast-addresses">Internet multicast addresses</a>. Potential conflicts with Internet multicast address assignments can be avoided by using <a href="http://www.ietf.org/rfc/rfc3180.txt">GLOP addressing</a> (<a href="http://en.wikipedia.org/wiki/Autonomous_system_%28Internet%29">AS</a> required) or <a href="http://www.ietf.org/rfc/rfc2365.txt">administratively scoped</a> addresses. Such addresses can be safely used on a network connected to the Internet without fear of conflict with multicast sources originating on the Internet. Administratively scoped addresses are roughly analogous to the unicast address space for <a href="http://www.ietf.org/rfc/rfc1918.txt">private internets</a>. Site-local multicast addresses are of the form <span class="emphasis"><em>239.255.x.y</em></span>, but can grow down to <span class="emphasis"><em>239.252.x.y</em></span> if needed. Organization-local multicast addresses are of the form <span class="emphasis"><em>239.192-251.x.y</em></span>, but can grow down to <span class="emphasis"><em>239.x.y.z</em></span> if needed.
					</div></li></ol></div><div class="para">
				For a more detailed treatment (57 pages!), see <a href="http://www.cisco.com/en/US/tech/tk828/technologies_white_paper09186a00802d4643.shtml">Cisco’s Guidelines for Enterprise IP Multicast Address Allocation</a> paper.
			</div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_configuring_corosync">
      ⁠</a>2.5.3.&nbsp;Configuring Corosync</h3></div></div></div><div class="para">
				In the past, at this point in the tutorial an explanation of how to configure and propagate corosync’s /etc/corosync.conf file would be necessary. Using pcs with the pcs daemon greatly simplifies this process by generating <span class="emphasis"><em>corosync.conf</em></span> across all the nodes in the cluster with a single command. The only thing required to achieve this is to authenticate as the pcs user <span class="emphasis"><em>hacluster</em></span> on one of the nodes in the cluster, and then issue the <span class="emphasis"><em>pcs cluster setup</em></span> command with a list of all the node names in the cluster.
			</div><pre class="programlisting"><span class="perl_Others"># pcs cluster auth pcmk-1 pcmk-2</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Username: hacluster
Password:
pcmk-<span class="perl_Float">1</span>: Authorized
pcmk-<span class="perl_Float">2</span>: Authorized

<span class="perl_Others"># pcs cluster setup mycluster pcmk-1 pcmk-2</span><span class="perl_Others"></span>
<span class="perl_Others"></span>pcmk-<span class="perl_Float">1</span>: Succeeded
pcmk-<span class="perl_Float">2</span>: Succeeded</pre><div class="para">
				That’s it. Corosync is configured across the cluster. If you received an authorization error for either of those commands, make sure you setup the <span class="emphasis"><em>hacluster</em></span> user account and password on every node in the cluster with the same password.
			</div><div class="para">
				The final /etc/corosync.conf configuration on each node should look something like the sample in Appendix B, Sample Corosync Configuration.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
					Pacemaker used to obtain membership and quorum from a custom Corosync plugin. This plugin also had the capability to start Pacemaker automatically when Corosync was started.
				</div><div class="para">
					Neither behavior is possible with Corosync 2.0 and beyond as support for plugins was removed. Instead, Pacemaker must be started as a separate service.
				</div><div class="para">
					Also, since Pacemaker made use of the plugin for message routing, a node using the plugin (Corosync prior to 2.0) cannot talk to one that isn’t (Corosync 2.0+). Rolling upgrades between these versions are therefor not possible and an alternate strategy <a id="idm254656619872">
      ⁠</a><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254656619872" class="footnote"><sup class="footnote">[7]</sup></a> must be used.
				</div></div></div></div></div><div class="footnotes"><br><hr width="100" align="left"><div id="ftn.idm254583041760" class="footnote"><div class="para"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254583041760" class="para"><sup class="para">[3] </sup></a>
				<a href="http://docs.fedoraproject.org/en-US/Fedora/20/html/Burning_ISO_images_to_disc/index.html">http://docs.fedoraproject.org/en-US/Fedora/20/html/Burning_ISO_images_to_disc/index.html</a>
			</div></div><div id="ftn.idm254560967936" class="footnote"><div class="para"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254560967936" class="para"><sup class="para">[4] </sup></a>
				<a href="http://docs.fedoraproject.org/en-US/Fedora/20/html/Installation_Guide/language-selection-x86.html">http://docs.fedoraproject.org/en-US/Fedora/20/html/Installation_Guide/language-selection-x86.html</a>
			</div></div><div id="ftn.idm254568859872" class="footnote"><div class="para"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254568859872" class="para"><sup class="para">[5] </sup></a>
				<a href="http://docs.fedoraproject.org/en-US/Fedora/20/html/Installation_Guide/s1-timezone-x86.html">http://docs.fedoraproject.org/en-US/Fedora/20/html/Installation_Guide/s1-timezone-x86.html</a>
			</div></div><div id="ftn.idm254660904336" class="footnote"><div class="para"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254660904336" class="para"><sup class="para">[6] </sup></a>
					This information is borrowed from, the now defunct, <a href="http://web.archive.org/web/20101211210054/http://29west.com/docs/THPM/multicast-address-assignment.html">http://web.archive.org/web/20101211210054/http://29west.com/docs/THPM/multicast-address-assignment.html</a>
				</div></div><div id="ftn.idm254656619872" class="footnote"><div class="para"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254656619872" class="para"><sup class="para">[7] </sup></a>
						<a href="http://www.clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Pacemaker_Explained/ap-upgrade.html">http://www.clusterlabs.org/doc/en-US/Pacemaker/1.1/html/Pacemaker_Explained/ap-upgrade.html</a>
					</div></div></div></div><div xml:lang="en-US" class="chapter" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="idm254584266640">
      ⁠</a>Chapter&nbsp;3.&nbsp;Pacemaker Tools</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_using_pacemaker_tools">3.1. Using Pacemaker Tools</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_using_pacemaker_tools">
      ⁠</a>3.1.&nbsp;Using Pacemaker Tools</h2></div></div></div><div class="para">
			In the dark past, configuring Pacemaker required the administrator to read and write XML. In true UNIX style, there were also a number of different commands that specialized in different aspects of querying and updating the cluster.
		</div><div class="para">
			All of that has been greatly simplified with the creation of unified command-line shells (and GUIs) that hide all the messy XML scaffolding.
		</div><div class="para">
			These shells take all the individual aspects required for managing and configuring a cluster, and packs them into one simple to use command line tool.
		</div><div class="para">
			They even allow you to queue up several changes at once and commit them atomically.
		</div><div class="para">
			There are currently two command-line shells that people use, <code class="literal">pcs</code> and <code class="literal">crmsh</code>. This edition of Clusters from Scratch is based on <code class="literal">pcs</code>. Start by taking some time to familiarize yourself with what it can do.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				The two shells share many concepts but the scope, layout and syntax does differ, so make sure you read the version of this guide that corresponds to the software installed on your system.
			</div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				Since <code class="literal">pcs</code> has the ability to manage all aspects of the cluster (both corosync and pacemaker), it requires a specific cluster stack to be in use, (corosync 2.0 with votequorum + Pacemaker version &gt;= 1.1.8).
			</div></div></div><pre class="programlisting"><span class="perl_Others"># pcs</span></pre><pre class="literallayout">Control and configure pacemaker and corosync.

Options:
    -h, --help  Display usage and exit
    -f file     Perform actions on file instead of active CIB
    --debug     Print all network traffic and external commands run
    --version   Print pcs version information

Commands:
    cluster     Configure cluster options and nodes
    resource    Manage cluster resources
    stonith     Configure fence devices
    constraint  Set resource constraints
    property    Set pacemaker properties
    status      View cluster status
    config      Print full cluster configuration</pre><div class="para">
			As you can see, the different aspects of cluster management are broken up into categories: resource, cluster, stonith, property, constraint, and status. To discover the functionality available in each of these categories, one can issue the command <span class="emphasis"><em>pcs &lt;category&gt; help</em></span>. Below is an example of all the options available under the status category.
		</div><pre class="programlisting"><span class="perl_Others"># pcs status help</span></pre><pre class="literallayout">Usage: pcs status [commands]...
View current cluster and resource status
Commands:
    [status]
        View all information about the cluster and resources

    resources
        View current status of cluster resources

    groups
        View currently configured groups and their resources

    cluster
        View current cluster status

    corosync
        View current membership information as seen by corosync

    nodes [corosync|both|config]
        View current status of nodes from pacemaker. If 'corosync' is
        specified, print nodes currently configured in corosync, if 'both'
        is specified, print nodes from both corosync &amp; pacemaker.  If 'config'
        is specified, print nodes from corosync &amp; pacemaker configuration.

    pcsd &lt;node&gt; ...
        Show the current status of pcsd on the specified nodes

    xml
        View xml version of status (output from crm_mon -r -1 -X)</pre><div class="para">
			Additionally, if you are interested in the Pacemaker version and supported cluster stack(s) available with your current Pacemaker installation, the pacemakerd --features option is available to you.
		</div><pre class="programlisting"><span class="perl_Others"># pacemakerd --features</span></pre><pre class="screen">Pacemaker 1.1.12 (Build: 3907e89)
 Supporting v3.0.9:  generated-manpages agent-manpages ascii-docs publican-docs ncurses libqb-logging libqb-ipc upstart systemd nagios  corosync-native atomic-attrd snmp acls</pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				If the SNMP and/or email options are not listed, then Pacemaker was not built to support them. This may be by the choice of your distribution or the required libraries may not have been available. Please contact whoever supplied you with the packages for more details.
			</div></div></div></div></div><div xml:lang="en-US" class="chapter" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="idm254653148832">
      ⁠</a>Chapter&nbsp;4.&nbsp;Verify Cluster Installation</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_start_the_cluster">4.1. Start the Cluster</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_verify_corosync_installation">4.2. Verify Corosync Installation</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_verify_pacemaker_installation">4.3. Verify Pacemaker Installation</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_start_the_cluster">
      ⁠</a>4.1.&nbsp;Start the Cluster</h2></div></div></div><div class="para">
			Now that corosync is configured, it is time to start the cluster. The command below will start corosync and pacemaker on both nodes in the cluster. If you are issuing the start command from a different node than the one you ran the <span class="emphasis"><em>pcs cluster auth</em></span> command on earlier, you must authenticate on current node you are logged into before you will be allowed to start the cluster.
		</div><pre class="programlisting"><span class="perl_Others"># pcs cluster start --all</span><span class="perl_Others"></span>
<span class="perl_Others"></span>pcmk-<span class="perl_Float">1</span>: Starting Cluster...
pcmk-<span class="perl_Float">2</span>: Starting Cluster...</pre><div class="para">
			An alternative to using the <span class="emphasis"><em>pcs cluster startall</em></span> command is to issue either of the below commands on each node in the cluster by hand.
		</div><pre class="programlisting"><span class="perl_Others"># pcs cluster start</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Starting Cluster...</pre><div class="para">
			or
		</div><pre class="programlisting"><span class="perl_Others"># systemctl start corosync.service</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># systemctl start pacemaker.service</span></pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_verify_corosync_installation">
      ⁠</a>4.2.&nbsp;Verify Corosync Installation</h2></div></div></div><div class="para">
			The first thing to check is if cluster communication is happy, for that we use <code class="literal">corosync-cfgtool</code>.
		</div><pre class="programlisting"><span class="perl_Others"># corosync-cfgtool -s</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Printing ring status.
Local node ID <span class="perl_Float">1</span>
RING ID 0
        id      = <span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span>
        status  = ring 0 active with no faults</pre><div class="para">
			We can see here that everything appears normal with our fixed IP address, not a 127.0.0.x loopback address, listed as the <code class="literal">id</code> and <code class="literal">no faults</code> for the status.
		</div><div class="para">
			If you see something different, you might want to start by checking the node’s network, firewall and selinux configurations.
		</div><div class="para">
			Next we check the membership and quorum APIs:
		</div><pre class="programlisting"><span class="perl_Others"># corosync-cmapctl  | grep members</span><span class="perl_Others"></span>
<span class="perl_Others"></span>runtime.totem.pg.mrp.srp.members.<span class="perl_Float">1.</span>ip (str) = r(0) ip(<span class="perl_Float">192.168</span>.<span class="perl_Float">122.101</span>)
runtime.totem.pg.mrp.srp.members.<span class="perl_Float">1.</span>join_count (u32) = <span class="perl_Float">1</span>
runtime.totem.pg.mrp.srp.members.<span class="perl_Float">1.</span>status (str) = joined
runtime.totem.pg.mrp.srp.members.<span class="perl_Float">2.</span>ip (str) = r(0) ip(<span class="perl_Float">192.168</span>.<span class="perl_Float">122.102</span>)
runtime.totem.pg.mrp.srp.members.<span class="perl_Float">2.</span>join_count (u32) = <span class="perl_Float">1</span>
runtime.totem.pg.mrp.srp.members.<span class="perl_Float">2.</span>status (str) = joined

<span class="perl_Others"># pcs status corosync</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Membership information
 --------------------------
    Nodeid      Votes Name
         <span class="perl_Float">1</span>          <span class="perl_Float">1</span> pcmk-<span class="perl_Float">1</span> (local)
         <span class="perl_Float">2</span>          <span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span></pre><div class="para">
			You should see both nodes have joined the cluster.
		</div><div class="para">
			All good!
		</div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_verify_pacemaker_installation">
      ⁠</a>4.3.&nbsp;Verify Pacemaker Installation</h2></div></div></div><div class="para">
			Now that we have confirmed that Corosync is functional we can check the rest of the stack. Pacemaker has already been started, so verify the necessary processes are running.
		</div><pre class="programlisting"><span class="perl_Others"># ps axf</span><span class="perl_Others"></span>
<span class="perl_Others"></span>  PID TTY      STAT   TIME COMMAND
    <span class="perl_Float">2</span> ?        S      0:00 [kthreadd]
...lots of processes...
<span class="perl_Float">28019</span> ?        Ssl    0:03 /usr/sbin/corosync
<span class="perl_Float">28047</span> ?        Ss     0:00 /usr/sbin/pacemakerd -f
<span class="perl_Float">28048</span> ?        Ss     0:00  \_ /usr/libexec/pacemaker/cib
<span class="perl_Float">28049</span> ?        Ss     0:00  \_ /usr/libexec/pacemaker/stonithd
<span class="perl_Float">28050</span> ?        Ss     0:00  \_ /usr/lib64/heartbeat/lrmd
<span class="perl_Float">28051</span> ?        Ss     0:00  \_ /usr/libexec/pacemaker/attrd
<span class="perl_Float">28052</span> ?        Ss     0:00  \_ /usr/libexec/pacemaker/pengine
<span class="perl_Float">28053</span> ?        Ss     0:00  \_ /usr/libexec/pacemaker/crmd</pre><div class="para">
			If that looks ok, check the pcs status output.
		</div><pre class="programlisting"><span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Last updated: Fri Sep <span class="perl_Float">14</span> 09:<span class="perl_Float">52</span>:<span class="perl_Float">25</span> <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> 09:<span class="perl_Float">51</span>:<span class="perl_Float">55</span> <span class="perl_Float">2012</span> via crmd on pcmk-<span class="perl_Float">2</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">2</span> (<span class="perl_Float">2</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
0 Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:</pre><div class="para">
			Next, check for any ERRORs during startup - there shouldn’t be any.
		</div><pre class="programlisting"><span class="perl_Others"># grep -i error /var/log/messages</span></pre><div class="para">
			or (on Fedora 20)
		</div><pre class="programlisting"><span class="perl_Others"># journalctl | grep -i error</span></pre><div class="para">
			Repeat these checks on the other node. The results should be the same.
		</div></div></div><div xml:lang="en-US" class="chapter" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="idm254567492480">
      ⁠</a>Chapter&nbsp;5.&nbsp;Creating an Active/Passive Cluster</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_exploring_the_existing_configuration">5.1. Exploring the Existing Configuration</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_adding_a_resource">5.2. Adding a Resource</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_perform_a_failover">5.3. Perform a Failover</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_quorum_and_two_node_clusters">5.3.1. Quorum and Two-Node Clusters</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_prevent_resources_from_moving_after_recovery">5.3.2. Prevent Resources from Moving after Recovery</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_exploring_the_existing_configuration">
      ⁠</a>5.1.&nbsp;Exploring the Existing Configuration</h2></div></div></div><div class="para">
			When Pacemaker starts up, it automatically records the number and details of the nodes in the cluster as well as which stack is being used and the version of Pacemaker being used.
		</div><div class="para">
			This is what the base configuration should look like.
		</div><pre class="programlisting"><span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">12</span>:01 <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> 09:<span class="perl_Float">51</span>:<span class="perl_Float">55</span> <span class="perl_Float">2012</span> via crmd on pcmk-<span class="perl_Float">2</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">1</span> (<span class="perl_Float">1</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
0 Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:</pre><div class="para">
			For those that are not of afraid of XML, you can see the raw cluster configuration and status by using the <code class="literal">pcs cluster cib</code> command.
		</div><div class="example"><a id="idm254660465728">
      ⁠</a><p class="title"><strong>Example&nbsp;5.1.&nbsp;The last XML you’ll see in this document</strong></p><div class="example-contents"><pre class="programlisting"><span class="perl_Others"># pcs cluster cib</span></pre><pre class="programlisting"><span class="perl_Keyword">&lt;cib</span><span class="perl_Others"> epoch=</span><span class="perl_String">"4"</span><span class="perl_Others"> num_updates=</span><span class="perl_String">"19"</span><span class="perl_Others"> admin_epoch=</span><span class="perl_String">"0"</span><span class="perl_Others"> validate-with=</span><span class="perl_String">"pacemaker-1.2"</span><span class="perl_Others"> crm_feature_set=</span><span class="perl_String">"3.0.6"</span><span class="perl_Others"> update-origin=</span><span class="perl_String">"pcmk-1"</span><span class="perl_Others"> update-client=</span><span class="perl_String">"crmd"</span><span class="perl_Others"> cib-last-written=</span><span class="perl_String">"Wed Aug  1 16:08:52 2012"</span><span class="perl_Others"> have-quorum=</span><span class="perl_String">"1"</span><span class="perl_Others"> dc-uuid=</span><span class="perl_String">"1"</span><span class="perl_Keyword">&gt;</span>
  <span class="perl_Keyword">&lt;configuration&gt;</span>
    <span class="perl_Keyword">&lt;crm_config&gt;</span>
      <span class="perl_Keyword">&lt;cluster_property_set</span><span class="perl_Others"> id=</span><span class="perl_String">"cib-bootstrap-options"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"cib-bootstrap-options-dc-version"</span><span class="perl_Others"> name=</span><span class="perl_String">"dc-version"</span><span class="perl_Others"> value=</span><span class="perl_String">"1.1.8-1.el7-60a19ed12fdb4d5c6a6b6767f52e5391e447fec0"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"cib-bootstrap-options-cluster-infrastructure"</span><span class="perl_Others"> name=</span><span class="perl_String">"cluster-infrastructure"</span><span class="perl_Others"> value=</span><span class="perl_String">"corosync"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;/cluster_property_set&gt;</span>
    <span class="perl_Keyword">&lt;/crm_config&gt;</span>
    <span class="perl_Keyword">&lt;nodes&gt;</span>
      <span class="perl_Keyword">&lt;node</span><span class="perl_Others"> id=</span><span class="perl_String">"1"</span><span class="perl_Others"> uname=</span><span class="perl_String">"pcmk-1"</span><span class="perl_Others"> type=</span><span class="perl_String">"normal"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;node</span><span class="perl_Others"> id=</span><span class="perl_String">"2"</span><span class="perl_Others"> uname=</span><span class="perl_String">"pcmk-2"</span><span class="perl_Others"> type=</span><span class="perl_String">"normal"</span><span class="perl_Keyword">/&gt;</span>
    <span class="perl_Keyword">&lt;/nodes&gt;</span>
    <span class="perl_Keyword">&lt;resources/&gt;</span>
    <span class="perl_Keyword">&lt;constraints/&gt;</span>
  <span class="perl_Keyword">&lt;/configuration&gt;</span>
  <span class="perl_Keyword">&lt;status&gt;</span>
    <span class="perl_Keyword">&lt;node_state</span><span class="perl_Others"> id=</span><span class="perl_String">"2"</span><span class="perl_Others"> uname=</span><span class="perl_String">"pcmk-2"</span><span class="perl_Others"> ha=</span><span class="perl_String">"active"</span><span class="perl_Others"> in_ccm=</span><span class="perl_String">"true"</span><span class="perl_Others"> crmd=</span><span class="perl_String">"online"</span><span class="perl_Others"> join=</span><span class="perl_String">"member"</span><span class="perl_Others"> expected=</span><span class="perl_String">"member"</span><span class="perl_Others"> crm-debug-origin=</span><span class="perl_String">"do_state_transition"</span><span class="perl_Others"> shutdown=</span><span class="perl_String">"0"</span><span class="perl_Keyword">&gt;</span>
      <span class="perl_Keyword">&lt;lrm</span><span class="perl_Others"> id=</span><span class="perl_String">"2"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;lrm_resources/&gt;</span>
      <span class="perl_Keyword">&lt;/lrm&gt;</span>
      <span class="perl_Keyword">&lt;transient_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"2"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;instance_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"status-2"</span><span class="perl_Keyword">&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"status-2-probe_complete"</span><span class="perl_Others"> name=</span><span class="perl_String">"probe_complete"</span><span class="perl_Others"> value=</span><span class="perl_String">"true"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;/instance_attributes&gt;</span>
      <span class="perl_Keyword">&lt;/transient_attributes&gt;</span>
    <span class="perl_Keyword">&lt;/node_state&gt;</span>
    <span class="perl_Keyword">&lt;node_state</span><span class="perl_Others"> id=</span><span class="perl_String">"1"</span><span class="perl_Others"> uname=</span><span class="perl_String">"pcmk-1"</span><span class="perl_Others"> ha=</span><span class="perl_String">"active"</span><span class="perl_Others"> in_ccm=</span><span class="perl_String">"true"</span><span class="perl_Others"> crmd=</span><span class="perl_String">"online"</span><span class="perl_Others"> join=</span><span class="perl_String">"member"</span><span class="perl_Others"> expected=</span><span class="perl_String">"member"</span><span class="perl_Others"> crm-debug-origin=</span><span class="perl_String">"do_state_transition"</span><span class="perl_Others"> shutdown=</span><span class="perl_String">"0"</span><span class="perl_Keyword">&gt;</span>
      <span class="perl_Keyword">&lt;lrm</span><span class="perl_Others"> id=</span><span class="perl_String">"1"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;lrm_resources/&gt;</span>
      <span class="perl_Keyword">&lt;/lrm&gt;</span>
      <span class="perl_Keyword">&lt;transient_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"1"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;instance_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"status-1"</span><span class="perl_Keyword">&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"status-1-probe_complete"</span><span class="perl_Others"> name=</span><span class="perl_String">"probe_complete"</span><span class="perl_Others"> value=</span><span class="perl_String">"true"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;/instance_attributes&gt;</span>
      <span class="perl_Keyword">&lt;/transient_attributes&gt;</span>
    <span class="perl_Keyword">&lt;/node_state&gt;</span>
  <span class="perl_Keyword">&lt;/status&gt;</span>
<span class="perl_Keyword">&lt;/cib&gt;</span></pre></div></div><div class="para">
			Before we make any changes, its a good idea to check the validity of the configuration.
		</div><pre class="programlisting"><span class="perl_Others"># crm_verify -L -V</span><span class="perl_Others"></span>
<span class="perl_Others"></span>   error: unpack_resources: Resource start-up disabled since no STONITH resources have been defined
   error: unpack_resources: Either configure some or disable STONITH with the stonith-enabled option
   error: unpack_resources: NOTE: Clusters with shared data need STONITH to ensure data integrity
Errors found during check: config not valid
  -V may provide more details</pre><div class="para">
			As you can see, the tool has found some errors.
		</div><div class="para">
			In order to guarantee the safety of your data <a id="idm254579049904">
      ⁠</a><a xmlns:d="http://docbook.org/ns/docbook" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254579049904" class="footnote"><sup class="footnote">[8]</sup></a> , the default for STONITH <a id="idm254648958784">
      ⁠</a><a xmlns:d="http://docbook.org/ns/docbook" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254648958784" class="footnote"><sup class="footnote">[9]</sup></a> in Pacemaker is <code class="literal">enabled</code>. However it also knows when no STONITH configuration has been supplied and reports this as a problem (since the cluster would not be able to make progress if a situation requiring node fencing arose).
		</div><div class="para">
			For now, we will disable this feature and configure it later in the Configuring STONITH section. It is important to note that the use of STONITH is highly encouraged, turning it off tells the cluster to simply pretend that failed nodes are safely powered off. Some vendors will even refuse to support clusters that have it disabled.
		</div><div class="para">
			To disable STONITH, we set the <span class="emphasis"><em>stonith-enabled</em></span> cluster option to false.
		</div><pre class="programlisting"><span class="perl_Others"># pcs property set stonith-enabled=false</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># crm_verify -L</span></pre><div class="para">
			With the new cluster option set, the configuration is now valid.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="warning"><div class="admonition_header"><p><strong>Warning</strong></p></div><div class="admonition"><div class="para">
				The use of stonith-enabled=false is completely inappropriate for a production cluster. We use it here to defer the discussion of its configuration which can differ widely from one installation to the next. See <a class="xref" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_what_is_stonith">Section&nbsp;9.1, “What Is STONITH”</a> for information on why STONITH is important and details on how to configure it.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_adding_a_resource">
      ⁠</a>5.2.&nbsp;Adding a Resource</h2></div></div></div><div class="para">
			The first thing we should do is configure an IP address. Regardless of where the cluster service(s) are running, we need a consistent address to contact them on. Here I will choose and add 192.168.122.120 as the floating address, give it the imaginative name ClusterIP and tell the cluster to check that its running every 30 seconds.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				The chosen address must not be one already associated with a physical node
			</div></div></div><pre class="screen"># pcs resource create ClusterIP ocf:heartbeat:IPaddr2 \
    ip=192.168.0.120 cidr_netmask=32 op monitor interval=30s</pre><div class="para">
			The other important piece of information here is ocf:heartbeat:IPaddr2.
		</div><div class="para">
			This tells Pacemaker three things about the resource you want to add. The first field, ocf, is the standard to which the resource script conforms to and where to find it. The second field is specific to OCF resources and tells the cluster which namespace to find the resource script in, in this case heartbeat. The last field indicates the name of the resource script.
		</div><div class="para">
			To obtain a list of the available resource standards (the ocf part of ocf:heartbeat:IPaddr2), run
		</div><pre class="programlisting"><span class="perl_Others"># pcs resource standards</span><span class="perl_Others"></span>
<span class="perl_Others"></span>ocf
lsb
service
systemd
stonith</pre><div class="para">
			To obtain a list of the available ocf resource providers (the heartbeat part of ocf:heartbeat:IPaddr2), run
		</div><pre class="programlisting"><span class="perl_Others"># pcs resource providers</span><span class="perl_Others"></span>
<span class="perl_Others"></span>heartbeat
linbit
pacemaker
redhat</pre><div class="para">
			Finally, if you want to see all the resource agents available for a specific ocf provider (the IPaddr2 part of ocf:heartbeat:IPaddr2), run
		</div><pre class="programlisting"><span class="perl_Others"># pcs resource agents ocf:heartbeat</span><span class="perl_Others"></span>
<span class="perl_Others"></span>AoEtarget
AudibleAlarm
CTDB
ClusterMon
Delay
Dummy
.
. (skipping lots of resources to save space)
.
IPaddr2
.
.
.
symlink
syslog-ng
tomcat
vmware</pre><div class="para">
			Now verify that the IP resource has been added and display the cluster’s status to see that it is now active.
		</div><pre class="programlisting"><span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">17</span>:00 <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">15</span>:48 <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">1</span> (<span class="perl_Float">1</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">1</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">1</span></pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_perform_a_failover">
      ⁠</a>5.3.&nbsp;Perform a Failover</h2></div></div></div><div class="para">
			Being a high-availability cluster, we should test failover of our new resource before moving on.
		</div><div class="para">
			First, find the node on which the IP address is running.
		</div><pre class="programlisting"><span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">17</span>:00 <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">15</span>:48 <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">1</span> (<span class="perl_Float">1</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">1</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">1</span></pre><div class="para">
			Shut down Pacemaker and Corosync on that machine.
		</div><pre class="programlisting"><span class="perl_Others">#pcs cluster stop pcmk-1</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Stopping Cluster...</pre><div class="para">
			Once Corosync is no longer running, go to the other node and check the cluster status.
		</div><pre class="programlisting"><span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">31</span>:01 <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">15</span>:48 <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">2</span> (<span class="perl_Float">2</span>) - partition WITHOUT quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">1</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">2</span> ]
OFFLINE: [ pcmk-<span class="perl_Float">1</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Stopped</pre><div class="para">
			There are three things to notice about the cluster’s current state. The first is that, as expected, <code class="literal">pcmk-1</code> is now offline. However we can also see that <code class="literal">ClusterIP</code> isn’t running anywhere!
		</div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_quorum_and_two_node_clusters">
      ⁠</a>5.3.1.&nbsp;Quorum and Two-Node Clusters</h3></div></div></div><div class="para">
				This is because the cluster no longer has quorum, as can be seen by the text "partition WITHOUT quorum" in the status output. In order to reduce the possibility of data corruption, Pacemaker’s default behavior is to stop all resources if the cluster does not have quorum.
			</div><div class="para">
				A cluster is said to have quorum when more than half the known or expected nodes are online, or for the mathematically inclined, whenever the following equation is true:
			</div><pre class="literallayout">total_nodes &lt; 2 * active_nodes</pre><div class="para">
				Therefore a two-node cluster only has quorum when both nodes are running, which is no longer the case for our cluster. This would normally make the creation of a two-node cluster pointless <a id="idm254560971392">
      ⁠</a><a xmlns:d="http://docbook.org/ns/docbook" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254560971392" class="footnote"><sup class="footnote">[10]</sup></a> , however it is possible to control how Pacemaker behaves when quorum is lost. In particular, we can tell the cluster to simply ignore quorum altogether.
			</div><pre class="programlisting"><span class="perl_Others"># pcs property set no-quorum-policy=ignore</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs property</span><span class="perl_Others"></span>
<span class="perl_Others"></span>dc-version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
cluster-infrastructure: corosync
stonith-enabled: false
no-quorum-policy: ignore</pre><div class="para">
				After a few moments, the cluster will start the IP address on the remaining node. Note that the cluster still does not have quorum.
			</div><pre class="programlisting"><span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">38</span>:<span class="perl_Float">11</span> <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">37</span>:<span class="perl_Float">53</span> <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">2</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">2</span> (<span class="perl_Float">2</span>) - partition WITHOUT quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">1</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">2</span> ]
OFFLINE: [ pcmk-<span class="perl_Float">1</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">2</span></pre><div class="para">
				Now simulate node recovery by restarting the cluster stack on <code class="literal">pcmk-1</code> and check the cluster’s status. Note, if you get an authentication error with the <span class="emphasis"><em>pcs cluster start pcmk-1</em></span> command, you must authenticate on the node using the <span class="emphasis"><em>pcs cluster auth pcmk pcmk-1 pcmk-2</em></span> command discussed earlier.
			</div><pre class="programlisting"><span class="perl_Others"># pcs cluster start pcmk-1</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Starting Cluster...
<span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:42:<span class="perl_Float">56</span> <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">37</span>:<span class="perl_Float">53</span> <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">2</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">2</span> (<span class="perl_Float">2</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">1</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">2</span></pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					In the dark days, the cluster may have moved the IP back to its original location (<code class="literal">pcmk-1</code>). Usually this is no longer the case.
				</div></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_prevent_resources_from_moving_after_recovery">
      ⁠</a>5.3.2.&nbsp;Prevent Resources from Moving after Recovery</h3></div></div></div><div class="para">
				In most circumstances, it is highly desirable to prevent healthy resources from being moved around the cluster. Moving resources almost always requires a period of downtime. For complex services like Oracle databases, this period can be quite long.
			</div><div class="para">
				To address this, Pacemaker has the concept of resource stickiness which controls how much a service prefers to stay running where it is. You may like to think of it as the "cost" of any downtime. By default, Pacemaker assumes there is zero cost associated with moving resources and will do so to achieve "optimal" <a id="idm254653039984">
      ⁠</a><a xmlns:d="http://docbook.org/ns/docbook" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254653039984" class="footnote"><sup class="footnote">[11]</sup></a> resource placement. We can specify a different stickiness for every resource, but it is often sufficient to change the default.
			</div><pre class="programlisting"><span class="perl_Others"># pcs resource rsc defaults resource-stickiness=100</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs resource rsc defaults</span><span class="perl_Others"></span>
<span class="perl_Others"></span>resource-stickiness: <span class="perl_Float">100</span></pre></div></div><div class="footnotes"><br><hr width="100" align="left"><div id="ftn.idm254579049904" class="footnote"><div class="para"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254579049904" class="para"><sup class="para">[8] </sup></a>
				If the data is corrupt, there is little point in continuing to make it available
			</div></div><div id="ftn.idm254648958784" class="footnote"><div class="para"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254648958784" class="para"><sup class="para">[9] </sup></a>
				A common node fencing mechanism. Used to ensure data integrity by powering off "bad" nodes
			</div></div><div id="ftn.idm254560971392" class="footnote"><div class="para"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254560971392" class="para"><sup class="para">[10] </sup></a>
					Actually some would argue that two-node clusters are always pointless, but that is an argument for another time
				</div></div><div id="ftn.idm254653039984" class="footnote"><div class="para"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254653039984" class="para"><sup class="para">[11] </sup></a>
					It should be noted that Pacemaker’s definition of optimal may not always agree with that of a human’s. The order in which Pacemaker processes lists of resources and nodes creates implicit preferences in situations where the administrator has not explicitly specified them
				</div></div></div></div><div xml:lang="en-US" class="chapter" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="idm254538357344">
      ⁠</a>Chapter&nbsp;6.&nbsp;Apache - Adding More Services</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_forward">6.1. Forward</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_installation">6.2. Installation</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_preparation">6.3. Preparation</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_enable_the_apache_status_url">6.4. Enable the Apache status URL</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_update_the_configuration">6.5. Update the Configuration</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_ensuring_resources_run_on_the_same_host">6.6. Ensuring Resources Run on the Same Host</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_controlling_resource_start_stop_ordering">6.7. Controlling Resource Start/Stop Ordering</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_specifying_a_preferred_location">6.8. Specifying a Preferred Location</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_manually_moving_resources_around_the_cluster">6.9. Manually Moving Resources Around the Cluster</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_giving_control_back_to_the_cluster">6.9.1. Giving Control Back to the Cluster</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_forward">
      ⁠</a>6.1.&nbsp;Forward</h2></div></div></div><div class="para">
			Now that we have a basic but functional active/passive two-node cluster, we’re ready to add some real services. We’re going to start with Apache because its a feature of many clusters and relatively simple to configure.
		</div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_installation">
      ⁠</a>6.2.&nbsp;Installation</h2></div></div></div><div class="para">
			Before continuing, we need to make sure Apache is installed on both hosts. We also need the wget tool in order for the cluster to be able to check the status of the Apache server.
		</div><pre class="programlisting"><span class="perl_Others"># yum install -y httpd wget</span></pre><pre class="literallayout">Loaded plugins: langpacks, presto, refresh-packagekit
fedora/metalink                                               | 2.6 kB     00:00
updates/metalink                                              | 3.2 kB     00:00
updates-testing/metalink                                      |  41 kB     00:00
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package httpd.x86_64 0:2.2.22-3.fc17 will be installed
--&gt; Processing Dependency: httpd-tools = 2.2.22-3.fc17 for package: httpd-2.2.22-3.fc17.x86_64
--&gt; Processing Dependency: apr-util-ldap for package: httpd-2.2.22-3.fc17.x86_64
--&gt; Processing Dependency: libaprutil-1.so.0()(64bit) for package: httpd-2.2.22-3.fc17.x86_64
--&gt; Processing Dependency: libapr-1.so.0()(64bit) for package: httpd-2.2.22-3.fc17.x86_64
--&gt; Running transaction check
---&gt; Package apr.x86_64 0:1.4.6-1.fc17 will be installed
---&gt; Package apr-util.x86_64 0:1.4.1-2.fc17 will be installed
---&gt; Package apr-util-ldap.x86_64 0:1.4.1-2.fc17 will be installed
---&gt; Package httpd-tools.x86_64 0:2.2.22-3.fc17 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

=====================================================================================
 Package             Arch         Version                Repository             Size
=====================================================================================
Installing:
 httpd               x86_64       2.2.22-3.fc17          updates-testing       823 k
 wget                x86_64       1.13.4-2.fc17          fedora                495 k
Installing for dependencies:
 apr                 x86_64       1.4.6-1.fc17           fedora                 99 k
 apr-util            x86_64       1.4.1-2.fc17           fedora                 78 k
 apr-util-ldap       x86_64       1.4.1-2.fc17           fedora                 17 k
 httpd-tools         x86_64       2.2.22-3.fc17          updates-testing        74 k

Transaction Summary
=====================================================================================
Install  1 Package (+4 Dependent packages)

Total download size: 1.1 M
Installed size: 3.5 M
Downloading Packages:
(1/6): apr-1.4.6-1.fc17.x86_64.rpm                            |  99 kB     00:00
(2/6): apr-util-1.4.1-2.fc17.x86_64.rpm                       |  78 kB     00:00
(3/6): apr-util-ldap-1.4.1-2.fc17.x86_64.rpm                  |  17 kB     00:00
(4/6): httpd-2.2.22-3.fc17.x86_64.rpm                         | 823 kB     00:01
(5/6): httpd-tools-2.2.22-3.fc17.x86_64.rpm                   |  74 kB     00:00
(6/6): wget-1.13.4-2.fc17.x86_64.rpm                          | 495 kB     00:01
-------------------------------------------------------------------------------------
Total                                                238 kB/s | 1.1 MB     00:04
Running Transaction Check
Running Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing : apr-1.4.6-1.fc17.x86_64                                           1/6
  Installing : apr-util-1.4.1-2.fc17.x86_64                                      2/6
  Installing : apr-util-ldap-1.4.1-2.fc17.x86_64                                 3/6
  Installing : httpd-tools-2.2.22-3.fc17.x86_64                                  4/6
  Installing : httpd-2.2.22-3.fc17.x86_64                                        5/6
  Installing : wget-1.13.4-2.fc17.x86_64                                         6/6
  Verifying  : apr-util-ldap-1.4.1-2.fc17.x86_64                                 1/6
  Verifying  : httpd-tools-2.2.22-3.fc17.x86_64                                  2/6
  Verifying  : apr-util-1.4.1-2.fc17.x86_64                                      3/6
  Verifying  : apr-1.4.6-1.fc17.x86_64                                           4/6
  Verifying  : httpd-2.2.22-3.fc17.x86_64                                        5/6
  Verifying  : wget-1.13.4-2.fc17.x86_64                                         6/6

Installed:
  httpd.x86_64 0:2.2.22-3.fc17              wget.x86_64 0:1.13.4-2.fc17

Dependency Installed:
  apr.x86_64 0:1.4.6-1.fc17                 apr-util.x86_64 0:1.4.1-2.fc17
  apr-util-ldap.x86_64 0:1.4.1-2.fc17       httpd-tools.x86_64 0:2.2.22-3.fc17

Complete!</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_preparation">
      ⁠</a>6.3.&nbsp;Preparation</h2></div></div></div><div class="para">
			First we need to create a page for Apache to serve up. On Fedora the default Apache docroot is /var/www/html, so we’ll create an index file there.
		</div><pre class="programlisting"><span class="perl_Others"># cat &lt;&lt;-END &gt;/var/www/html/index.html</span><span class="perl_Others"></span>
<span class="perl_Others"></span> &lt;html&gt;
 &lt;body&gt;My Test Site - pcmk-<span class="perl_Float">1</span>&lt;/body&gt;
 &lt;/html&gt;
END</pre><div class="para">
			For the moment, we will simplify things by serving up only a static site and manually sync the data between the two nodes. So run the command again on pcmk-2.
		</div><pre class="programlisting">[root@pcmk-<span class="perl_Float">2</span> ~]# cat &lt;&lt;-END &gt;/var/www/html/index.html
 &lt;html&gt;
  &lt;body&gt;My Test Site - pcmk-<span class="perl_Float">2</span>&lt;/body&gt;
 &lt;/html&gt;
 END</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_enable_the_apache_status_url">
      ⁠</a>6.4.&nbsp;Enable the Apache status URL</h2></div></div></div><div class="para">
			In order to monitor the health of your Apache instance, and recover it if it fails, the resource agent used by Pacemaker assumes the server-status URL is available. Look for the following in <span class="emphasis"><em>/etc/httpd/conf/httpd.conf</em></span> and make sure it is not disabled or commented out:
		</div><pre class="programlisting"><span class="perl_Function">&lt;Location</span><span class="perl_Others"> /server-status</span><span class="perl_Function">&gt;</span><span class="perl_Error"></span>
<span class="perl_Error"></span><span class="perl_Others">   SetHandler server-status</span>
<span class="perl_Others">   Order deny,allow
   Deny from all
   Allow from 127.0.0.1
&lt;/Location</span><span class="perl_Function">&gt;</span></pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_update_the_configuration">
      ⁠</a>6.5.&nbsp;Update the Configuration</h2></div></div></div><div class="para">
			At this point, Apache is ready to go, all that needs to be done is to add it to the cluster. Lets call the resource WebSite. We need to use an OCF script called apache in the heartbeat namespace <a id="idm254658182816">
      ⁠</a><a xmlns:d="http://docbook.org/ns/docbook" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#ftn.idm254658182816" class="footnote"><sup class="footnote">[12]</sup></a> , the only required parameter is the path to the main Apache configuration file and we’ll tell the cluster to check once a minute that apache is still running.
		</div><pre class="screen">pcs resource create WebSite ocf:heartbeat:apache  \
      configfile=/etc/httpd/conf/httpd.conf \
      statusurl="http://localhost/server-status" op monitor interval=1min</pre><div class="para">
			By default, the operation timeout for all resource’s start, stop, and monitor operations is 20 seconds. In many cases this timeout period is less than the advised timeout period. For the purposes of this tutorial, we will adjust the global operation timeout default to 240 seconds.
		</div><pre class="programlisting"><span class="perl_Others"># pcs resource op defaults timeout=240s</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs resource op defaults</span><span class="perl_Others"></span>
<span class="perl_Others"></span>timeout: <span class="perl_Float">240</span>s</pre><div class="para">
			After a short delay, we should see the cluster start apache
		</div><pre class="programlisting"><span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">51</span>:<span class="perl_Float">27</span> <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">10</span>:<span class="perl_Float">50</span>:46 <span class="perl_Float">2012</span> via crm_attribute on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">2</span> (<span class="perl_Float">2</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">2</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">2</span>
 WebSite        (ocf::heartbeat:apache):        Started pcmk-<span class="perl_Float">1</span></pre><div class="para">
			Wait a moment, the WebSite resource isn’t running on the same host as our IP address!
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				If, in the <code class="literal">pcs status</code> output, you see the WebSite resource has failed to start, then you’ve likely not enabled the status URL correctly. You can check if this is the problem by running:
			</div><pre class="literallayout">wget http://127.0.0.1/server-status</pre><div class="para">
				If you see <code class="literal">Connection refused</code> in the output, then this is indeed the problem. Check to ensure that <code class="literal">Allow from 127.0.0.1</code> is present for the <code class="literal">&lt;Location /server-status&gt;</code> block.
			</div></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_ensuring_resources_run_on_the_same_host">
      ⁠</a>6.6.&nbsp;Ensuring Resources Run on the Same Host</h2></div></div></div><div class="para">
			To reduce the load on any one machine, Pacemaker will generally try to spread the configured resources across the cluster nodes. However we can tell the cluster that two resources are related and need to run on the same host (or not at all). Here we instruct the cluster that WebSite can only run on the host that ClusterIP is active on.
		</div><div class="para">
			To achieve this we use a colocation constraint that indicates it is mandatory for WebSite to run on the same node as ClusterIP. The "mandatory" part of the colocation constraint is indicated by using a score of INFINITY. The INFINITY score also means that if ClusterIP is not active anywhere, WebSite will not be permitted to run.
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				If ClusterIP is not active anywhere, WebSite will not be permitted to run anywhere.
			</div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
				Colocation constraints are "directional", in that they imply certain things about the order in which the two resources will have a location chosen. In this case we’re saying <code class="literal">WebSite</code> needs to be placed on the same machine as <code class="literal">ClusterIP</code>, this implies that we must know the location of <code class="literal">ClusterIP</code> before choosing a location for <code class="literal">WebSite</code>.
			</div></div></div><pre class="programlisting"><span class="perl_Others"># pcs constraint colocation add WebSite ClusterIP INFINITY</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs constraint</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Location Constraints:
Ordering Constraints:
Colocation Constraints:
  WebSite with ClusterIP
<span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">11</span>:00:44 <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">11</span>:00:<span class="perl_Float">25</span> <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">2</span> (<span class="perl_Float">2</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">2</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">2</span>
 WebSite        (ocf::heartbeat:apache):        Started pcmk-<span class="perl_Float">2</span></pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_controlling_resource_start_stop_ordering">
      ⁠</a>6.7.&nbsp;Controlling Resource Start/Stop Ordering</h2></div></div></div><div class="para">
			When Apache starts, it binds to the available IP addresses. It doesn’t know about any addresses we add afterwards, so not only do they need to run on the same node, but we need to make sure ClusterIP is already active before we start WebSite. We do this by adding an ordering constraint.
		</div><div class="para">
			By default all order constraints are mandatory constraints unless otherwise configured. This means that the recovery of ClusterIP will also trigger the recovery of WebSite.
		</div><pre class="programlisting"><span class="perl_Others"># pcs constraint order ClusterIP then WebSite</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Adding ClusterIP WebSite (kind: Mandatory) (Options: first-action=start then-action=start)
<span class="perl_Others"># pcs constraint</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Location Constraints:
Ordering Constraints:
  start ClusterIP then start WebSite
Colocation Constraints:
  WebSite with ClusterIP</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_specifying_a_preferred_location">
      ⁠</a>6.8.&nbsp;Specifying a Preferred Location</h2></div></div></div><div class="para">
			Pacemaker does not rely on any sort of hardware symmetry between nodes, so it may well be that one machine is more powerful than the other. In such cases it makes sense to host the resources there if it is available. To do this we create a location constraint.
		</div><div class="para">
			In the location constraint below, we are saying the WebSite resource prefers the node pcmk-1 with a score of 50. The score here indicates how badly we’d like the resource to run somewhere.
		</div><pre class="programlisting"><span class="perl_Others"># pcs constraint location WebSite prefers pcmk-1=50</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs constraint</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Location Constraints:
  Resource: WebSite
    Enabled on: pcmk-<span class="perl_Float">1</span> (score:<span class="perl_Float">50</span>)
Ordering Constraints:
  start ClusterIP then start WebSite
Colocation Constraints:
  WebSite with ClusterIP
<span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">11</span>:06:<span class="perl_Float">37</span> <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">11</span>:06:<span class="perl_Float">26</span> <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">2</span> (<span class="perl_Float">2</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">2</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">2</span>
 WebSite        (ocf::heartbeat:apache):        Started pcmk-<span class="perl_Float">2</span></pre><div class="para">
			Wait a minute, the resources are still on pcmk-2!
		</div><div class="para">
			Even though we now prefer pcmk-1 over pcmk-2, that preference is (intentionally) less than the resource stickiness (how much we preferred not to have unnecessary downtime).
		</div><div class="para">
			To see the current placement scores, you can use a tool called crm_simulate
		</div><pre class="programlisting"><span class="perl_Others"># crm_simulate -sL</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Current cluster status:
Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

 ClusterIP      (ocf:heartbeat:IPaddr2):        Started pcmk-<span class="perl_Float">2</span>
 WebSite        (ocf:heartbeat:apache): Started pcmk-<span class="perl_Float">2</span>

Allocation scores:
native_color: ClusterIP allocation score on pcmk-<span class="perl_Float">1</span>: <span class="perl_Float">50</span>
native_color: ClusterIP allocation score on pcmk-<span class="perl_Float">2</span>: <span class="perl_Float">200</span>
native_color: WebSite allocation score on pcmk-<span class="perl_Float">1</span>: -INFINITY
native_color: WebSite allocation score on pcmk-<span class="perl_Float">2</span>: <span class="perl_Float">100</span>

Transition Summary:</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_manually_moving_resources_around_the_cluster">
      ⁠</a>6.9.&nbsp;Manually Moving Resources Around the Cluster</h2></div></div></div><div class="para">
			There are always times when an administrator needs to override the cluster and force resources to move to a specific location. By updating our previous location constraint with a score of INFINITY, WebSite will be forced to move to pcmk-1.
		</div><pre class="programlisting"><span class="perl_Others"># pcs constraint location WebSite prefers pcmk-1=INFINITY</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs constraint all</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Location Constraints:
  Resource: WebSite
    Enabled on: pcmk-<span class="perl_Float">1</span> (score:INFINITY) (id:location-WebSite-pcmk-<span class="perl_Float">1</span>-INFINITY)
Ordering Constraints:
  start ClusterIP then start WebSite (Mandatory) (id:order-ClusterIP-WebSite-mandatory)
Colocation Constraints:
  WebSite with ClusterIP (INFINITY) (id:colocation-WebSite-ClusterIP-INFINITY)
<span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">11</span>:<span class="perl_Float">16</span>:<span class="perl_Float">26</span> <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">11</span>:<span class="perl_Float">16</span>:<span class="perl_Float">18</span> <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">2</span> (<span class="perl_Float">2</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">2</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">1</span>
 WebSite        (ocf::heartbeat:apache):        Started pcmk-<span class="perl_Float">1</span></pre><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_giving_control_back_to_the_cluster">
      ⁠</a>6.9.1.&nbsp;Giving Control Back to the Cluster</h3></div></div></div><div class="para">
				Once we’ve finished whatever activity that required us to move the resources to pcmk-1, in our case nothing, we can then allow the cluster to resume normal operation with the unmove command. Since we previously configured a default stickiness, the resources will remain on pcmk-1.
			</div><pre class="programlisting"><span class="perl_Others"># pcs constraint all</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Location Constraints:
  Resource: WebSite
    Enabled on: pcmk-<span class="perl_Float">1</span> (score:INFINITY) (id:location-WebSite-pcmk-<span class="perl_Float">1</span>-INFINITY)
Ordering Constraints:
  start ClusterIP then start WebSite (Mandatory) (id:order-ClusterIP-WebSite-mandatory)
Colocation Constraints:
  WebSite with ClusterIP (INFINITY) (id:colocation-WebSite-ClusterIP-INFINITY)
<span class="perl_Others"># pcs constraint rm location-WebSite-pcmk-1-INFINITY</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs constraint</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Location Constraints:
Ordering Constraints:
  start ClusterIP then start WebSite
Colocation Constraints:
  WebSite with ClusterIP</pre><div class="para">
				Note that the constraint is now gone. If we check the cluster status, we can also see that as expected the resources are still active on pcmk-1.
			</div><pre class="programlisting"><span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">11</span>:<span class="perl_Float">57</span>:<span class="perl_Float">12</span> <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">11</span>:<span class="perl_Float">57</span>:03 <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">2</span> (<span class="perl_Float">2</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">2</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">1</span>
 WebSite        (ocf::heartbeat:apache):        Started pcmk-<span class="perl_Float">1</span></pre></div></div><div class="footnotes"><br><hr width="100" align="left"><div id="ftn.idm254658182816" class="footnote"><div class="para"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254658182816" class="para"><sup class="para">[12] </sup></a>
				Compare the key used here ocf:heartbeat:apache with the one we used earlier for the IP address: ocf:heartbeat:IPaddr2
			</div></div></div></div><div xml:lang="en-US" class="chapter" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="idm254658409520">
      ⁠</a>Chapter&nbsp;7.&nbsp;Replicated Storage with DRBD</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_background">7.1. Background</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_install_the_drbd_packages">7.2. Install the DRBD Packages</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configure_drbd">7.3. Configure DRBD</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_create_a_partition_for_drbd">7.3.1. Create A Partition for DRBD</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_write_the_drbd_config">7.3.2. Write the DRBD Config</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_initialize_and_load_drbd">7.3.3. Initialize and Load DRBD</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_populate_drbd_with_data">7.3.4. Populate DRBD with Data</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configure_the_cluster_for_drbd">7.4. Configure the Cluster for DRBD</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_testing_migration">7.4.1. Testing Migration</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_background">
      ⁠</a>7.1.&nbsp;Background</h2></div></div></div><div class="para">
			Even if you’re serving up static websites, having to manually synchronize the contents of that website to all the machines in the cluster is not ideal. For dynamic websites, such as a wiki, it’s not even an option. Not everyone care afford network-attached storage but somehow the data needs to be kept in sync. Enter DRBD which can be thought of as network based RAID-1. See <a href="http://www.drbd.org/">http://www.drbd.org/</a> for more details.
		</div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_install_the_drbd_packages">
      ⁠</a>7.2.&nbsp;Install the DRBD Packages</h2></div></div></div><div class="para">
			Since its inclusion in the upstream 2.6.33 kernel, everything needed to use DRBD has shiped with Fedora since version 13. All you need to do is install it:
		</div><pre class="programlisting"><span class="perl_Others"># yum install -y drbd-pacemaker drbd-udev</span></pre><pre class="literallayout">Loaded plugins: langpacks, presto, refresh-packagekit
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package drbd-pacemaker.x86_64 0:8.3.11-5.fc17 will be installed
--&gt; Processing Dependency: drbd-utils = 8.3.11-5.fc17 for package: drbd-pacemaker-8.3.11-5.fc17.x86_64
---&gt; Package drbd-udev.x86_64 0:8.3.11-5.fc17 will be installed
--&gt; Running transaction check
---&gt; Package drbd-utils.x86_64 0:8.3.11-5.fc17 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

======================================================================================
 Package              Arch         Version                Repository             Size
======================================================================================
Installing:
 drbd-pacemaker       x86_64       8.3.11-5.fc17          updates-testing        22 k
 drbd-udev            x86_64       8.3.11-5.fc17          updates-testing       6.4 k
Installing for dependencies:
 drbd-utils           x86_64       8.3.11-5.fc17          updates-testing       183 k

Transaction Summary
======================================================================================
Install  2 Packages (+1 Dependent package)

Total download size: 212 k
Installed size: 473 k
Downloading Packages:
(1/3): drbd-pacemaker-8.3.11-5.fc17.x86_64.rpm                 |  22 kB     00:00
(2/3): drbd-udev-8.3.11-5.fc17.x86_64.rpm                      | 6.4 kB     00:00
(3/3): drbd-utils-8.3.11-5.fc17.x86_64.rpm                     | 183 kB     00:00
--------------------------------------------------------------------------------------
Total                                                 293 kB/s | 212 kB     00:00
Running Transaction Check
Running Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing : drbd-utils-8.3.11-5.fc17.x86_64                                    1/3
  Installing : drbd-pacemaker-8.3.11-5.fc17.x86_64                                2/3
  Installing : drbd-udev-8.3.11-5.fc17.x86_64                                     3/3
  Verifying  : drbd-pacemaker-8.3.11-5.fc17.x86_64                                1/3
  Verifying  : drbd-udev-8.3.11-5.fc17.x86_64                                     2/3
  Verifying  : drbd-utils-8.3.11-5.fc17.x86_64                                    3/3

Installed:
  drbd-pacemaker.x86_64 0:8.3.11-5.fc17        drbd-udev.x86_64 0:8.3.11-5.fc17

Dependency Installed:
  drbd-utils.x86_64 0:8.3.11-5.fc17

Complete!</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_configure_drbd">
      ⁠</a>7.3.&nbsp;Configure DRBD</h2></div></div></div><div class="para">
			Before we configure DRBD, we need to set aside some disk for it to use.
		</div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_create_a_partition_for_drbd">
      ⁠</a>7.3.1.&nbsp;Create A Partition for DRBD</h3></div></div></div><div class="para">
				If you have more than 1Gb free, feel free to use it. For this guide however, 1Gb is plenty of space for a single html file and sufficient for later holding the GFS2 metadata.
			</div><pre class="programlisting"><span class="perl_Others"># vgdisplay | grep -e Name -e Free</span><span class="perl_Others"></span>
<span class="perl_Others"></span>  VG Name               vg_pcmk1
  Free  PE / Size       <span class="perl_Float">31</span> / <span class="perl_Float">992.00</span> MiB
<span class="perl_Others"># lvs</span><span class="perl_Others"></span>
<span class="perl_Others"></span>  LV        VG          Attr     LSize   Pool Origin Data%  Move Log Copy%  Convert
  lv_root   vg_pcmk1 -wi-ao--   <span class="perl_Float">8.56</span>g
  lv_swap   vg_pcmk1 -wi-ao-- <span class="perl_Float">960.00</span>m
<span class="perl_Others"># lvcreate -n drbd-demo -L 1G vg_pcmk1</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Logical volume <span class="perl_String">"drbd-demo"</span> created
<span class="perl_Others"># lvs</span><span class="perl_Others"></span>
<span class="perl_Others"></span>  LV        VG          Attr     LSize   Pool Origin Data%  Move Log Copy%  Convert
  drbd-demo vg_pcmk1 -wi-a--- <span class="perl_Float">1.00</span>G
  lv_root   vg_pcmk1 -wi-ao--   <span class="perl_Float">8.56</span>g
  lv_swap   vg_pcmk1 -wi-ao-- <span class="perl_Float">960.00</span>m</pre><div class="para">
				Repeat this on the second node, be sure to use the same size partition.
			</div><pre class="programlisting"><span class="perl_Others"># ssh pcmk-2 -- lvs</span><span class="perl_Others"></span>
<span class="perl_Others"></span>LV   VG    Attr  LSize  Origin Snap% Move Log Copy% Convert
  lv_root   vg_pcmk1 -wi-ao--   <span class="perl_Float">8.56</span>g
  lv_swap   vg_pcmk1 -wi-ao-- <span class="perl_Float">960.00</span>m
<span class="perl_Others"># ssh pcmk-2 -- lvcreate -n drbd-demo -L 1G vg_pcmk1</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Logical volume <span class="perl_String">"drbd-demo"</span> created
<span class="perl_Others"># ssh pcmk-2 -- lvs</span><span class="perl_Others"></span>
<span class="perl_Others"></span>LV    VG    Attr  LSize  Origin Snap% Move Log Copy% Convert
  drbd-demo vg_pcmk1 -wi-a--- <span class="perl_Float">1.00</span>G
  lv_root   vg_pcmk1 -wi-ao--   <span class="perl_Float">8.56</span>g
  lv_swap   vg_pcmk1 -wi-ao-- <span class="perl_Float">960.00</span>m</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_write_the_drbd_config">
      ⁠</a>7.3.2.&nbsp;Write the DRBD Config</h3></div></div></div><div class="para">
				There is no series of commands for building a DRBD configuration, so simply copy the configuration below to /etc/drbd.conf
			</div><div class="para">
				Detailed information on the directives used in this configuration (and other alternatives) is available from <a href="http://www.drbd.org/users-guide/ch-configure.html">http://www.drbd.org/users-guide/ch-configure.html</a>
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="warning"><div class="admonition_header"><p><strong>Warning</strong></p></div><div class="admonition"><div class="para">
					Be sure to use the names and addresses of your nodes if they differ from the ones used in this guide.
				</div></div></div><pre class="literallayout">global {
 usage-count yes;
}
common {
 protocol C;
}
resource wwwdata {
 meta-disk internal;
 device  /dev/drbd1;
 syncer {
  verify-alg sha1;
 }
 net {
  allow-two-primaries;
 }
 on pcmk-1 {
  disk   /dev/vg_pcmk1/drbd-demo;
  address  192.168.122.101:7789;
 }
 on pcmk-2 {
  disk   /dev/vg_pcmk1/drbd-demo;
  address  192.168.122.102:7789;
 }
}</pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					TODO: Explain the reason for the allow-two-primaries option
				</div></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_initialize_and_load_drbd">
      ⁠</a>7.3.3.&nbsp;Initialize and Load DRBD</h3></div></div></div><div class="para">
				With the configuration in place, we can now perform the DRBD initialization
			</div><pre class="programlisting"><span class="perl_Others"># drbdadm create-md wwwdata</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Writing meta data...
initializing activity log
NOT initialized bitmap
New drbd meta data block successfully created.
success</pre><div class="para">
				Now load the DRBD kernel module and confirm that everything is sane
			</div><pre class="programlisting"><span class="perl_Others"># modprobe drbd</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># drbdadm up wwwdata</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># cat /proc/drbd</span><span class="perl_Others"></span>
<span class="perl_Others"></span>version: <span class="perl_Float">8.3</span>.<span class="perl_Float">11</span> (api:<span class="perl_Float">88</span>/proto:<span class="perl_Float">86</span>-<span class="perl_Float">96</span>)
srcversion: 0D2B62DEDB020A425130935

 <span class="perl_Float">1</span>: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----
    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:<span class="perl_Float">1</span> wo:f oos:<span class="perl_Float">1015740</span></pre><div class="para">
				Repeat on the second node
			</div><pre class="programlisting"><span class="perl_Others"># ssh pcmk-2 -- drbdadm --force create-md wwwdata</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Writing meta data...
initializing activity log
NOT initialized bitmap
New drbd meta data block successfully created.
success
<span class="perl_Others"># ssh pcmk-2 -- modprobe drbd</span><span class="perl_Others"></span>
<span class="perl_Others"></span>WARNING: Deprecated config file /etc/modprobe.conf, all config files belong into /etc/modprobe.d/.
<span class="perl_Others"># ssh pcmk-2 -- drbdadm up wwwdata</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># ssh pcmk-2 -- cat /proc/drbd</span><span class="perl_Others"></span>
<span class="perl_Others"></span>version: <span class="perl_Float">8.3</span>.<span class="perl_Float">11</span> (api:<span class="perl_Float">88</span>/proto:<span class="perl_Float">86</span>-<span class="perl_Float">96</span>)
srcversion: 0D2B62DEDB020A425130935

 <span class="perl_Float">1</span>: cs:Connected ro:Secondary/Secondary ds:Inconsistent/Inconsistent C r-----
    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0 ep:<span class="perl_Float">1</span> wo:f oos:<span class="perl_Float">1015740</span></pre><div class="para">
				Now we need to tell DRBD which set of data to use. Since both sides contain garbage, we can run the following on pcmk-1:
			</div><pre class="programlisting"><span class="perl_Others"># drbdadm -- --overwrite-data-of-peer primary wwwdata</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># cat /proc/drbd</span><span class="perl_Others"></span>
<span class="perl_Others"></span>version: <span class="perl_Float">8.3</span>.<span class="perl_Float">11</span> (api:<span class="perl_Float">88</span>/proto:<span class="perl_Float">86</span>-<span class="perl_Float">96</span>)
srcversion: 0D2B62DEDB020A425130935

 <span class="perl_Float">1</span>: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----
    ns:<span class="perl_Float">8064</span> nr:0 dw:0 dr:<span class="perl_Float">8728</span> al:0 bm:0 lo:0 pe:<span class="perl_Float">1</span> ua:0 ap:0 ep:<span class="perl_Float">1</span> wo:f oos:<span class="perl_Float">1007804</span>
        [&gt;....................] sync'ed:  0.<span class="perl_Float">9</span>% (<span class="perl_Float">1007804</span>/<span class="perl_Float">1015740</span>)K
        finish: 0:<span class="perl_Float">12</span>:<span class="perl_Float">35</span> speed: <span class="perl_Float">1</span>,<span class="perl_Float">320</span> (<span class="perl_Float">1</span>,<span class="perl_Float">320</span>) K/sec</pre><div class="para">
				After a while, the sync should finish and you’ll see:
			</div><pre class="programlisting"><span class="perl_Others"># cat /proc/drbd</span><span class="perl_Others"></span>
<span class="perl_Others"></span>version: <span class="perl_Float">8.3</span>.<span class="perl_Float">11</span> (api:<span class="perl_Float">88</span>/proto:<span class="perl_Float">86</span>-<span class="perl_Float">96</span>)
srcversion: 0D2B62DEDB020A425130935

 <span class="perl_Float">1</span>: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----
    ns:<span class="perl_Float">1015740</span> nr:0 dw:0 dr:<span class="perl_Float">1016404</span> al:0 bm:<span class="perl_Float">62</span> lo:0 pe:0 ua:0 ap:0 ep:<span class="perl_Float">1</span> wo:f oos:0</pre><div class="para">
				pcmk-1 is now in the Primary state which allows it to be written to. Which means it’s a good point at which to create a filesystem and populate it with some data to serve up via our WebSite resource.
			</div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_populate_drbd_with_data">
      ⁠</a>7.3.4.&nbsp;Populate DRBD with Data</h3></div></div></div><pre class="programlisting"><span class="perl_Others"># mkfs.ext4 /dev/drbd1</span><span class="perl_Others"></span>
<span class="perl_Others"></span>mke2fs <span class="perl_Float">1.42</span> (<span class="perl_Float">29</span>-Nov-<span class="perl_Float">2011</span>)
Filesystem label=
OS type: Linux
Block size=4096 (log=<span class="perl_Float">2</span>)
Fragment size=4096 (log=<span class="perl_Float">2</span>)
Stride=0 blocks, Stripe width=0 blocks
<span class="perl_Float">63488</span> inodes, <span class="perl_Float">253935</span> blocks
<span class="perl_Float">12696</span> blocks (<span class="perl_Float">5.00</span>%) reserved <span class="perl_Keyword">for</span> the super user
First data block=0
Maximum filesystem blocks=<span class="perl_Float">260046848</span>
<span class="perl_Float">8</span> block groups
<span class="perl_Float">32768</span> blocks per group, <span class="perl_Float">32768</span> fragments per group
<span class="perl_Float">7936</span> inodes per group
Superblock backups stored on blocks:
        <span class="perl_Float">32768</span>, <span class="perl_Float">98304</span>, <span class="perl_Float">163840</span>, <span class="perl_Float">229376</span>

Allocating group tables: done
Writing inode tables: done
Creating journal (4096 blocks): done
Writing superblocks and filesystem accounting information: done</pre><div class="para">
				Now mount the newly created filesystem so we can create our index file
			</div><pre class="programlisting"><span class="perl_Others"># mount /dev/drbd1 /mnt/</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># cat &lt;&lt;-END &gt;/mnt/index.html</span><span class="perl_Others"></span>
<span class="perl_Others"></span> &lt;html&gt;
  &lt;body&gt;My Test Site - drbd&lt;/body&gt;
 &lt;/html&gt;
END
<span class="perl_Others"># umount /dev/drbd1</span></pre></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_configure_the_cluster_for_drbd">
      ⁠</a>7.4.&nbsp;Configure the Cluster for DRBD</h2></div></div></div><div class="para">
			One handy feature pcs has is the ability to queue up several changes into a file and commit those changes atomically. To do this, start by populating the file with the current raw xml config from the cib. This can be done using the following command.
		</div><pre class="programlisting"><span class="perl_Others"># pcs cluster cib drbd_cfg</span></pre><div class="para">
			Now using the pcs -f option, make changes to the configuration saved in the drbd_cfg file. These changes will not be seen by the cluster until the drbd_cfg file is pushed into the live cluster’s cib later on.
		</div><pre class="screen"># pcs -f drbd_cfg resource create WebData ocf:linbit:drbd \
         drbd_resource=wwwdata op monitor interval=60s
# pcs -f drbd_cfg resource master WebDataClone WebData \
         master-max=1 master-node-max=1 clone-max=2 clone-node-max=1 \
         notify=true</pre><pre class="programlisting"><span class="perl_Others"># pcs -f drbd_cfg resource show</span><span class="perl_Others"></span>
<span class="perl_Others"></span> ClusterIP      (ocf::heartbeat:IPaddr2) Started
 WebSite        (ocf::heartbeat:apache) Started
 Master/Slave Set: WebDataClone [WebData]
     Stopped: [ WebData:0 WebData:<span class="perl_Float">1</span> ]</pre><div class="para">
			After you are satisfied with all the changes, you can commit all the changes at once by pushing the drbd_cfg file into the live cib.
		</div><pre class="programlisting"><span class="perl_Others"># pcs cluster push cib drbd_cfg</span><span class="perl_Others"></span>
<span class="perl_Others"></span>CIB updated

<span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">12</span>:<span class="perl_Float">19</span>:49 <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">12</span>:<span class="perl_Float">19</span>:<span class="perl_Float">13</span> <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">2</span> (<span class="perl_Float">2</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
4 Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">1</span>
 WebSite        (ocf::heartbeat:apache):        Started pcmk-<span class="perl_Float">1</span>
 Master/Slave Set: WebDataClone [WebData]
     Masters: [ pcmk-<span class="perl_Float">1</span> ]
     Slaves: [ pcmk-<span class="perl_Float">2</span> ]</pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
				TODO: Include details on adding a second DRBD resource
			</div></div></div><div class="para">
			Now that DRBD is functioning we can configure a Filesystem resource to use it. In addition to the filesystem’s definition, we also need to tell the cluster where it can be located (only on the DRBD Primary) and when it is allowed to start (after the Primary was promoted).
		</div><div class="para">
			We are going to take a shortcut when creating the resource this time though. Instead of explicitly saying we want the <span class="emphasis"><em>ocf:heartbeat:Filesystem</em></span> script, we are only going to ask for <span class="emphasis"><em>Filesystem</em></span>. We can do this because we know there is only one resource script named <span class="emphasis"><em>Filesystem</em></span> available to pacemaker, and that pcs is smart enough to fill in the <span class="emphasis"><em>ocf:heartbeat</em></span> portion for us correctly in the configuration. If there were multiple <span class="emphasis"><em>Filesystem</em></span> scripts from different ocf providers, we would need to specify the exact one we wanted to use.
		</div><div class="para">
			Once again we will queue up our changes to a file and then push the new configuration to the cluster as the final step.
		</div><pre class="screen"># pcs cluster cib fs_cfg
# pcs -f fs_cfg resource create WebFS Filesystem \
         device="/dev/drbd/by-res/wwwdata" directory="/var/www/html" \
         fstype="ext4"</pre><pre class="programlisting"><span class="perl_Others"># pcs -f fs_cfg constraint colocation add WebFS WebDataClone INFINITY with-rsc-role=Master</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs -f fs_cfg constraint order promote WebDataClone then start WebFS</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Adding WebDataClone WebFS (kind: Mandatory) (Options: first-action=promote then-action=start)</pre><div class="para">
			We also need to tell the cluster that Apache needs to run on the same machine as the filesystem and that it must be active before Apache can start.
		</div><pre class="programlisting"><span class="perl_Others"># pcs -f fs_cfg constraint colocation add WebSite WebFS INFINITY</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs -f fs_cfg constraint order WebFS then WebSite</span></pre><div class="para">
			Now review the updated configuration.
		</div><pre class="programlisting"><span class="perl_Others"># pcs -f fs_cfg constraint</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Location Constraints:
Ordering Constraints:
  start ClusterIP then start WebSite
  WebFS then WebSite
  promote WebDataClone then start WebFS
Colocation Constraints:
  WebSite with ClusterIP
  WebFS with WebDataClone (with-rsc-role:Master)
  WebSite with WebFS

<span class="perl_Others"># pcs -f fs_cfg resource show</span><span class="perl_Others"></span>
<span class="perl_Others"></span> ClusterIP      (ocf::heartbeat:IPaddr2) Started
 WebSite        (ocf::heartbeat:apache) Started
 Master/Slave Set: WebDataClone [WebData]
     Masters: [ pcmk-<span class="perl_Float">1</span> ]
     Slaves: [ pcmk-<span class="perl_Float">2</span> ]
 WebFS  (ocf::heartbeat:Filesystem) Stopped</pre><div class="para">
			After reviewing the new configuration, we again upload it and watch the cluster put it into effect.
		</div><pre class="programlisting"><span class="perl_Others"># pcs cluster push cib fs_cfg</span><span class="perl_Others"></span>
<span class="perl_Others"></span>CIB updated
<span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span> Last updated: Fri Aug <span class="perl_Float">10</span> <span class="perl_Float">12</span>:47:01 <span class="perl_Float">2012</span>

 Last change: Fri Aug <span class="perl_Float">10</span> <span class="perl_Float">12</span>:46:<span class="perl_Float">55</span> <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">1</span>
 Stack: corosync
 Current DC: pcmk-<span class="perl_Float">1</span> (<span class="perl_Float">1</span>) - partition with quorum
 Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
 <span class="perl_Float">2</span> Nodes configured, unknown expected votes
 <span class="perl_Float">5</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">1</span>
 WebSite        (ocf::heartbeat:apache):        Started pcmk-<span class="perl_Float">1</span>
 Master/Slave Set: WebDataClone [WebData]
     Masters: [ pcmk-<span class="perl_Float">1</span> ]
     Slaves: [ pcmk-<span class="perl_Float">2</span> ]
 WebFS  (ocf::heartbeat:Filesystem):    Started pcmk-<span class="perl_Float">1</span></pre><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_testing_migration">
      ⁠</a>7.4.1.&nbsp;Testing Migration</h3></div></div></div><div class="para">
				We could shut down the active node again, but another way to safely simulate recovery is to put the node into what is called "standby mode". Nodes in this state tell the cluster that they are not allowed to run resources. Any resources found active there will be moved elsewhere. This feature can be particularly useful when updating the resources' packages.
			</div><div class="para">
				Put the local node into standby mode and observe the cluster move all the resources to the other node. Note also that the node’s status will change to indicate that it can no longer host resources.
			</div><pre class="programlisting"><span class="perl_Others"># pcs cluster standby pcmk-1</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">12</span>:41:<span class="perl_Float">12</span> <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">12</span>:41:08 <span class="perl_Float">2012</span> via crm_attribute on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">1</span> (<span class="perl_Float">1</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">5</span> Resources configured.

Node pcmk-<span class="perl_Float">1</span> (<span class="perl_Float">1</span>): standby
Online: [ pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

ClusterIP       (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">2</span>
WebSite (ocf::heartbeat:apache):        Started pcmk-<span class="perl_Float">2</span>
 Master/Slave Set: WebDataClone [WebData]
     Masters: [ pcmk-<span class="perl_Float">2</span> ]
     Stopped: [ WebData:<span class="perl_Float">1</span> ]
WebFS   (ocf::heartbeat:Filesystem):    Started pcmk-<span class="perl_Float">2</span></pre><div class="para">
				Once we’ve done everything we needed to on pcmk-1 (in this case nothing, we just wanted to see the resources move), we can allow the node to be a full cluster member again.
			</div><pre class="programlisting"><span class="perl_Others"># pcs cluster unstandby pcmk-1</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">12</span>:43:02 <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">12</span>:42:<span class="perl_Float">57</span> <span class="perl_Float">2012</span> via crm_attribute on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">1</span> (<span class="perl_Float">1</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">5</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">2</span>
 WebSite        (ocf::heartbeat:apache):        Started pcmk-<span class="perl_Float">2</span>
 Master/Slave Set: WebDataClone [WebData]
     Masters: [ pcmk-<span class="perl_Float">2</span> ]
     Slaves: [ pcmk-<span class="perl_Float">1</span> ]
 WebFS  (ocf::heartbeat:Filesystem):    Started pcmk-<span class="perl_Float">2</span></pre><div class="para">
				Notice that our resource stickiness settings prevent the services from migrating back to pcmk-1.
			</div></div></div></div><div xml:lang="en-US" class="chapter" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="idm254658206640">
      ⁠</a>Chapter&nbsp;8.&nbsp;Conversion to Active/Active</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_requirements">8.1. Requirements</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_installing_the_required_software">8.1.1. Installing the required Software</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_create_a_gfs2_filesystem">8.2. Create a GFS2 Filesystem</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#GFS2_prep">8.2.1. Preparation</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_create_and_populate_an_gfs2_partition">8.2.2. Create and Populate an GFS2 Partition</a></span></dt></dl></dd><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_reconfigure_the_cluster_for_gfs2">8.3. Reconfigure the Cluster for GFS2</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_reconfigure_pacemaker_for_active_active">8.4. Reconfigure Pacemaker for Active/Active</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_testing_recovery">8.4.1. Testing Recovery</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_requirements">
      ⁠</a>8.1.&nbsp;Requirements</h2></div></div></div><div class="para">
			The primary requirement for an Active/Active cluster is that the data required for your services is available, simultaneously, on both machines. Pacemaker makes no requirement on how this is achieved, you could use a SAN if you had one available, however since DRBD supports multiple Primaries, we can also use that.
		</div><div class="para">
			The only hitch is that we need to use a cluster-aware filesystem. The one we used earlier with DRBD, ext4, is not one of those. Both OCFS2 and GFS2 are supported, however here we will use GFS2 which comes with Fedora 17.
		</div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_installing_the_required_software">
      ⁠</a>8.1.1.&nbsp;Installing the required Software</h3></div></div></div><pre class="programlisting"><span class="perl_Others"># yum install -y gfs2-utils dlm kernel-modules-extra</span></pre><pre class="literallayout">Loaded plugins: langpacks, presto, refresh-packagekit
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package dlm.x86_64 0:3.99.4-1.fc17 will be installed
---&gt; Package gfs2-utils.x86_64 0:3.1.4-3.fc17 will be installed
---&gt; Package kernel-modules-extra.x86_64 0:3.4.4-3.fc17 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

================================================================================
 Package                Arch       Version          Repository           Size
================================================================================
Installing:
 dlm                    x86_64     3.99.4-1.fc17    updates              83 k
 gfs2-utils             x86_64     3.1.4-3.fc17     fedora              214 k
 kernel-modules-extra   x86_64     3.4.4-3.fc17     updates             1.7 M

Transaction Summary
================================================================================
Install  3 Packages

Total download size: 1.9 M
Installed size: 7.7 M
Downloading Packages:
(1/3): dlm-3.99.4-1.fc17.x86_64.rpm                         |  83 kB     00:00
(2/3): gfs2-utils-3.1.4-3.fc17.x86_64.rpm                   | 214 kB     00:00
(3/3): kernel-modules-extra-3.4.4-3.fc17.x86_64.rpm         | 1.7 MB     00:01
--------------------------------------------------------------------------------
Total                                              615 kB/s | 1.9 MB     00:03
Running Transaction Check
Running Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing : kernel-modules-extra-3.4.4-3.fc17.x86_64                 1/3
  Installing : gfs2-utils-3.1.4-3.fc17.x86_64                           2/3
  Installing : dlm-3.99.4-1.fc17.x86_64                                 3/3
  Verifying  : dlm-3.99.4-1.fc17.x86_64                                 1/3
  Verifying  : gfs2-utils-3.1.4-3.fc17.x86_64                           2/3
  Verifying  : kernel-modules-extra-3.4.4-3.fc17.x86_64                 3/3

Installed:
  dlm.x86_64 0:3.99.4-1.fc17
  gfs2-utils.x86_64 0:3.1.4-3.fc17
  kernel-modules-extra.x86_64 0:3.4.4-3.fc17

Complete!</pre></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_create_a_gfs2_filesystem">
      ⁠</a>8.2.&nbsp;Create a GFS2 Filesystem</h2></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="GFS2_prep">
      ⁠</a>8.2.1.&nbsp;Preparation</h3></div></div></div><div class="para">
				Before we do anything to the existing partition, we need to make sure it is unmounted. We do this by telling the cluster to stop the WebFS resource. This will ensure that other resources (in our case, Apache) using WebFS are not only stopped, but stopped in the correct order.
			</div><pre class="programlisting"><span class="perl_Others"># pcs resource disable WebFS</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs resource</span><span class="perl_Others"></span>
<span class="perl_Others"></span> ClusterIP      (ocf::heartbeat:IPaddr2) Started
 WebSite        (ocf::heartbeat:apache) Stopped
 Master/Slave Set: WebDataClone [WebData]
     Masters: [ pcmk-<span class="perl_Float">2</span> ]
     Slaves: [ pcmk-<span class="perl_Float">1</span> ]
 WebFS  (ocf::heartbeat:Filesystem) Stopped</pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					Note that both Apache and WebFS have been stopped.
				</div></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_create_and_populate_an_gfs2_partition">
      ⁠</a>8.2.2.&nbsp;Create and Populate an GFS2 Partition</h3></div></div></div><div class="para">
				Now that the cluster stack and integration pieces are running smoothly, we can create an GFS2 partition.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="warning"><div class="admonition_header"><p><strong>Warning</strong></p></div><div class="admonition"><div class="para">
					This will erase all previous content stored on the DRBD device. Ensure you have a copy of any important data.
				</div></div></div><div class="para">
				We need to specify a number of additional parameters when creating a GFS2 partition.
			</div><div class="para">
				First we must use the -p option to specify that we want to use the the Kernel’s DLM. Next we use -j to indicate that it should reserve enough space for two journals (one per node accessing the filesystem).
			</div><div class="para">
				Lastly, we use -t to specify the lock table name. The format for this field is <code class="literal">clustername:fsname</code>. For the <code class="literal">fsname</code>, we need to use the same value as specified in <span class="emphasis"><em>corosync.conf</em></span> for <code class="literal">cluster_name</code>. If you setup corosync with the same cluster name we used in this tutorial, cluster name will be <span class="emphasis"><em>mycluster</em></span>. If you are unsure what your cluster name is, open up /etc/corosync/corosync.conf, or execute the command <span class="emphasis"><em>pcs cluster corosync pcmk-1</em></span> to view the corosync config. The cluster name will be in the <code class="literal">totem</code> block.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="important"><div class="admonition_header"><p><strong>Important</strong></p></div><div class="admonition"><div class="para">
					We must run the next command on whichever node last had <span class="emphasis"><em>/dev/drbd</em></span> mounted. Otherwise you will receive the message:
				</div><pre class="screen">/dev/drbd1: Read-only file system</pre></div></div><pre class="programlisting"><span class="perl_Others"># ssh pcmk-2 -- mkfs.gfs2 -p lock_dlm -j 2 -t mycluster:web /dev/drbd1</span><span class="perl_Others"></span>
<span class="perl_Others"></span>This will destroy any data on /dev/drbd1.
It appears to contain: Linux rev <span class="perl_Float">1.0</span> ext4 filesystem data, UUID=dc45fff3-c47a-4db2-<span class="perl_Float">96f</span>7-a8049a323fe4 (extents) (large files) (huge files)
Are you sure you want to proceed? [y/n]y
Device:                    /dev/drbd1
Blocksize:                 4096
Device Size                0.<span class="perl_Float">97</span> GB (<span class="perl_Float">253935</span> blocks)
Filesystem Size:           0.<span class="perl_Float">97</span> GB (<span class="perl_Float">253932</span> blocks)
Journals:                  <span class="perl_Float">2</span>
Resource Groups:           4
Locking Protocol:          <span class="perl_String">"lock_dlm"</span>
Lock Table:                <span class="perl_String">"mycluster"</span>
UUID:                      ed293a02-<span class="perl_Float">9</span>eee-<span class="perl_Float">3f</span>a3-ed1c-435ef1fd0116</pre><pre class="programlisting"><span class="perl_Others"># pcs cluster cib dlm_cfg</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs -f dlm_cfg resource create dlm ocf:pacemaker:controld op monitor interval=60s</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs -f dlm_cfg resource clone dlm clone-max=2 clone-node-max=1</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs -f dlm_cfg resource show</span><span class="perl_Others"></span>
<span class="perl_Others"></span> ClusterIP      (ocf::heartbeat:IPaddr2) Started
 WebSite        (ocf::heartbeat:apache) Stopped
 Master/Slave Set: WebDataClone [WebData]
     Masters: [ pcmk-<span class="perl_Float">2</span> ]
     Slaves: [ pcmk-<span class="perl_Float">1</span> ]
 WebFS  (ocf::heartbeat:Filesystem) Stopped
 Clone Set: dlm-clone [dlm]
     Stopped: [ dlm:0 dlm:<span class="perl_Float">1</span> ]
<span class="perl_Others"># pcs cluster push cib dlm_cfg</span><span class="perl_Others"></span>
<span class="perl_Others"></span>CIB updated
<span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">12</span>:<span class="perl_Float">54</span>:<span class="perl_Float">50</span> <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">12</span>:<span class="perl_Float">54</span>:43 <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">1</span> (<span class="perl_Float">1</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">7</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 ClusterIP      (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">2</span>
 WebSite        (ocf::heartbeat:apache):        Stopped
 Master/Slave Set: WebDataClone [WebData]
     Masters: [ pcmk-<span class="perl_Float">2</span> ]
     Slaves: [ pcmk-<span class="perl_Float">1</span> ]
 WebFS  (ocf::heartbeat:Filesystem):    Stopped
 Clone Set: dlm-clone [dlm]
     Started: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]</pre><div class="para">
				Then (re)populate the new filesystem with data (web pages). For now we’ll create another variation on our home page.
			</div><pre class="programlisting"><span class="perl_Others"># mount /dev/drbd1 /mnt/</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># cat &lt;&lt;-END &gt;/mnt/index.html</span><span class="perl_Others"></span>
<span class="perl_Others"></span>&lt;html&gt;
&lt;body&gt;My Test Site - GFS2&lt;/body&gt;
&lt;/html&gt;
END
<span class="perl_Others"># umount /dev/drbd1</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># drbdadm verify wwwdata</span></pre></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_reconfigure_the_cluster_for_gfs2">
      ⁠</a>8.3.&nbsp;Reconfigure the Cluster for GFS2</h2></div></div></div><div class="para">
			With the WebFS resource stopped, lets update the configuration.
		</div><pre class="programlisting"><span class="perl_Others"># pcs resource show WebFS</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Resource: WebFS
  device: /dev/drbd/by-res/wwwdata
  directory: /var/www/html
  fstype: ext4
  target-role: Stopped</pre><div class="para">
			The fstype option needs to be updated to gfs2 instead of ext4.
		</div><pre class="programlisting"><span class="perl_Others"># pcs resource update WebFS fstype=gfs2</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs resource show WebFS</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Resource: WebFS
  device: /dev/drbd/by-res/wwwdata
  directory: /var/www/html
  fstype: gfs2
  target-role: Stopped
CIB updated</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_reconfigure_pacemaker_for_active_active">
      ⁠</a>8.4.&nbsp;Reconfigure Pacemaker for Active/Active</h2></div></div></div><div class="para">
			Almost everything is in place. Recent versions of DRBD are capable of operating in Primary/Primary mode and the filesystem we’re using is cluster aware. All we need to do now is reconfigure the cluster to take advantage of this.
		</div><div class="para">
			This will involve a number of changes, so we’ll want work with a local cib file.
		</div><pre class="programlisting"><span class="perl_Others"># pcs cluster cib active_cfg</span></pre><div class="para">
			There’s no point making the services active on both locations if we can’t reach them, so lets first clone the IP address. Cloned IPaddr2 resources use an iptables rule to ensure that each request only gets processed by one of the two clone instances. The additional meta options tell the cluster how many instances of the clone we want (one "request bucket" for each node) and that if all other nodes fail, then the remaining node should hold all of them. Otherwise the requests would be simply discarded.
		</div><pre class="screen"># pcs -f active_cfg resource clone ClusterIP \
     globally-unique=true clone-max=2 clone-node-max=2</pre><div class="para">
			Notice when the ClusterIP becomes a clone, the constraints referencing ClusterIP now reference the clone. This is done automatically by pcs.
		</div><pre class="programlisting"><span class="perl_Others"># pcs -f active_cfg constraint</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Location Constraints:
Ordering Constraints:
  start ClusterIP-clone then start WebSite
  WebFS then WebSite
  promote WebDataClone then start WebFS
Colocation Constraints:
  WebSite with ClusterIP-clone
  WebFS with WebDataClone (with-rsc-role:Master)
  WebSite with WebFS</pre><div class="para">
			Now we must tell the ClusterIP how to decide which requests are processed by which hosts. To do this we must specify the clusterip_hash parameter.
		</div><pre class="programlisting"><span class="perl_Others"># pcs -f active_cfg resource update ClusterIP clusterip_hash=sourceip</span></pre><div class="para">
			Next we need to convert the filesystem and Apache resources into clones.
		</div><div class="para">
			Notice how pcs automatically updates the relevant constraints again.
		</div><pre class="programlisting"><span class="perl_Others"># pcs -f active_cfg resource clone WebFS</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs -f active_cfg resource clone WebSite</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs -f active_cfg constraint</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Location Constraints:
Ordering Constraints:
  start ClusterIP-clone then start WebSite-clone
  WebFS-clone then WebSite-clone
  promote WebDataClone then start WebFS-clone
Colocation Constraints:
  WebSite-clone with ClusterIP-clone
  WebFS-clone with WebDataClone (with-rsc-role:Master)
  WebSite-clone with WebFS-clone</pre><div class="para">
			The last step is to tell the cluster that it is now allowed to promote both instances to be Primary (aka. Master).
		</div><pre class="programlisting"><span class="perl_Others"># pcs -f active_cfg resource update WebDataClone master-max=2</span></pre><div class="para">
			Review the configuration before uploading it to the cluster, quitting the shell and watching the cluster’s response
		</div><pre class="programlisting"><span class="perl_Others"># pcs cluster push cib active_cfg</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs resource enable WebFS</span></pre><div class="para">
			After all the processes are started the status should look similar to this.
		</div><pre class="programlisting"><span class="perl_Others"># pcs resource</span><span class="perl_Others"></span>
<span class="perl_Others"></span> Master/Slave Set: WebDataClone [WebData]
     Masters: [ pcmk-<span class="perl_Float">2</span> pcmk-<span class="perl_Float">1</span> ]
 Clone Set: dlm-clone [dlm]
     Started: [ pcmk-<span class="perl_Float">2</span> pcmk-<span class="perl_Float">1</span> ]
 Clone Set: ClusterIP-clone [ClusterIP] (unique)
     ClusterIP:0        (ocf::heartbeat:IPaddr2) Started
     ClusterIP:<span class="perl_Float">1</span>        (ocf::heartbeat:IPaddr2) Started
 Clone Set: WebFS-clone [WebFS]
     Started: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]
 Clone Set: WebSite-clone [WebSite]
     Started: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]</pre><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_testing_recovery">
      ⁠</a>8.4.1.&nbsp;Testing Recovery</h3></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					TODO: Put one node into standby to demonstrate failover
				</div></div></div></div></div></div><div xml:lang="en-US" class="chapter" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="idm254568673376">
      ⁠</a>Chapter&nbsp;9.&nbsp;Configure STONITH</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_what_is_stonith">9.1. What Is STONITH</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_what_stonith_device_should_you_use">9.2. What STONITH Device Should You Use</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configuring_stonith">9.3. Configuring STONITH</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_example">9.4. Example</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_what_is_stonith">
      ⁠</a>9.1.&nbsp;What Is STONITH</h2></div></div></div><div class="para">
			STONITH is an acronym for Shoot-The-Other-Node-In-The-Head and it protects your data from being corrupted by rogue nodes or concurrent access.
		</div><div class="para">
			Just because a node is unresponsive, this doesn’t mean it isn’t accessing your data. The only way to be 100% sure that your data is safe, is to use STONITH so we can be certain that the node is truly offline, before allowing the data to be accessed from another node.
		</div><div class="para">
			STONITH also has a role to play in the event that a clustered service cannot be stopped. In this case, the cluster uses STONITH to force the whole node offline, thereby making it safe to start the service elsewhere.
		</div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_what_stonith_device_should_you_use">
      ⁠</a>9.2.&nbsp;What STONITH Device Should You Use</h2></div></div></div><div class="para">
			It is crucial that the STONITH device can allow the cluster to differentiate between a node failure and a network one.
		</div><div class="para">
			The biggest mistake people make in choosing a STONITH device is to use remote power switch (such as many on-board IMPI controllers) that shares power with the node it controls. In such cases, the cluster cannot be sure if the node is really offline, or active and suffering from a network fault.
		</div><div class="para">
			Likewise, any device that relies on the machine being active (such as SSH-based "devices" used during testing) are inappropriate.
		</div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_configuring_stonith">
      ⁠</a>9.3.&nbsp;Configuring STONITH</h2></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="orderedlist"><ol class="arabic"><li class="listitem"><div class="para">
					Find the correct driver: <code class="literal">pcs stonith list</code>
				</div></li><li class="listitem"><div class="para">
					Find the parameters associated with the device: <code class="literal">pcs stonith describe &lt;agent name&gt;</code>
				</div></li><li class="listitem"><div class="para">
					Create a local config to make changes to <code class="literal">pcs cluster cib stonith_cfg</code>
				</div></li><li class="listitem"><div class="para">
					Create the fencing resource using <code class="literal">pcs -f stonith_cfg stonith create &lt;stonith_id&gt; &lt;stonith device type&gt; [stonith device options]</code>
				</div></li><li class="listitem"><div class="para">
					Set stonith-enable to true. <code class="literal">pcs -f stonith_cfg property set stonith-enabled=true</code>
				</div></li><li class="listitem"><div class="para">
					If the device does not know how to fence nodes based on their uname, you may also need to set the special <code class="literal">pcmk_host_map</code> parameter. See <code class="literal">man stonithd</code> for details.
				</div></li><li class="listitem"><div class="para">
					If the device does not support the list command, you may also need to set the special <code class="literal">pcmk_host_list</code> and/or <code class="literal">pcmk_host_check</code> parameters. See <code class="literal">man stonithd</code> for details.
				</div></li><li class="listitem"><div class="para">
					If the device does not expect the victim to be specified with the port parameter, you may also need to set the special <code class="literal">pcmk_host_argument</code> parameter. See <code class="literal">man stonithd</code> for details.
				</div></li><li class="listitem"><div class="para">
					Commit the new configuration. <code class="literal">pcs cluster push cib stonith_cfg</code>
				</div></li><li class="listitem"><div class="para">
					Once the stonith resource is running, you can test it by executing: <code class="literal">stonith_admin --reboot nodename</code>. Although you might want to stop the cluster on that machine first.
				</div></li></ol></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_example">
      ⁠</a>9.4.&nbsp;Example</h2></div></div></div><div class="para">
			Assuming we have an chassis containing four nodes and an IPMI device active on 10.0.0.1, then we would chose the fence_ipmilan driver in step 2 and obtain the following list of parameters
		</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Obtaining a list of STONITH Parameters</div>
				
<pre class="programlisting"><span class="perl_Others"># pcs stonith describe fence_ipmilan</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Stonith options <span class="perl_Keyword">for</span>: fence_ipmilan
  auth: IPMI Lan Auth type (md5, password, or none)
  ipaddr: IPMI Lan IP to talk to
  passwd: Password (<span class="perl_Keyword">if</span> required) to control power on IPMI device
  passwd_script: Script to retrieve password (<span class="perl_Keyword">if</span> required)
  lanplus: Use Lanplus
  login: Username/Login (<span class="perl_Keyword">if</span> required) to control power on IPMI device
  action: Operation to perform. Valid operations: on, off, reboot, status, list, diag, monitor or metadata
  timeout: Timeout (sec) <span class="perl_Keyword">for</span> IPMI operation
  cipher: Ciphersuite to use (same as ipmitool -C parameter)
  method: Method to fence (onoff or cycle)
  power_wait: Wait X seconds after on/off operation
  delay: Wait X seconds before fencing is started
  privlvl: Privilege level on IPMI device
  verbose: Verbose mode</pre>
			</div><div class="para">
			from which we would create a STONITH resource fragment that might look like this
		</div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Sample STONITH Resource</div>
				
<pre class="screen"># pcs cluster cib stonith_cfg
# pcs -f stonith_cfg stonith create impi-fencing fence_ipmilan \
      pcmk_host_list="pcmk-1 pcmk-2" ipaddr=10.0.0.1 login=testuser \
      passwd=acd123 op monitor interval=60s</pre>
			</div><pre class="programlisting"><span class="perl_Others"># pcs -f stonith_cfg stonith</span><span class="perl_Others"></span>
<span class="perl_Others"></span> impi-fencing   (stonith:fence_ipmilan) Stopped</pre><div class="para">
			And finally, since we disabled it earlier, we need to re-enable STONITH. At this point we should have the following configuration.
		</div><pre class="programlisting"><span class="perl_Others"># pcs -f stonith_cfg property set stonith-enabled=true</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs -f stonith_cfg property</span><span class="perl_Others"></span>
<span class="perl_Others"></span>dc-version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
cluster-infrastructure: corosync
no-quorum-policy: ignore
stonith-enabled: true</pre><div class="para">
			Now push the configuration into the cluster.
		</div><pre class="programlisting"><span class="perl_Others"># pcs cluster push cib stonith_cfg</span></pre></div></div><div xml:lang="en-US" class="appendix" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="_configuration_recap"></a>Configuration Recap</h1></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><dl class="toc"><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_final_cluster_configuration">A.1. Final Cluster Configuration</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_node_list">A.2. Node List</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_cluster_options">A.3. Cluster Options</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_resources">A.4. Resources</a></span></dt><dd><dl><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_default_options">A.4.1. Default Options</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_fencing">A.4.2. Fencing</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_service_address">A.4.3. Service Address</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_drbd_shared_storage">A.4.4. DRBD - Shared Storage</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_cluster_filesystem">A.4.5. Cluster Filesystem</a></span></dt><dt><span class="section"><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_apache">A.4.6. Apache</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_final_cluster_configuration">
      ⁠</a>A.1.&nbsp;Final Cluster Configuration</h2></div></div></div><pre class="programlisting"><span class="perl_Others"># pcs resource</span><span class="perl_Others"></span>
<span class="perl_Others"></span> Master/Slave Set: WebDataClone [WebData]
     Masters: [ pcmk-<span class="perl_Float">2</span> pcmk-<span class="perl_Float">1</span> ]
 Clone Set: dlm-clone [dlm]
     Started: [ pcmk-<span class="perl_Float">2</span> pcmk-<span class="perl_Float">1</span> ]
 Clone Set: ClusterIP-clone [ClusterIP] (unique)
     ClusterIP:0        (ocf::heartbeat:IPaddr2) Started
     ClusterIP:<span class="perl_Float">1</span>        (ocf::heartbeat:IPaddr2) Started
 Clone Set: WebFS-clone [WebFS]
     Started: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]
 Clone Set: WebSite-clone [WebSite]
     Started: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]
<span class="perl_Others"># pcs resource rsc defaults</span><span class="perl_Others"></span>
<span class="perl_Others"></span>resource-stickiness: <span class="perl_Float">100</span>
<span class="perl_Others"># pcs resource op defaults</span><span class="perl_Others"></span>
<span class="perl_Others"></span>timeout: <span class="perl_Float">240</span>s
<span class="perl_Others"># pcs stonith</span><span class="perl_Others"></span>
<span class="perl_Others"></span> impi-fencing   (stonith:fence_ipmilan) Started
<span class="perl_Others"># pcs property</span><span class="perl_Others"></span>
<span class="perl_Others"></span>dc-version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
cluster-infrastructure: corosync
no-quorum-policy: ignore
stonith-enabled: true
<span class="perl_Others"># pcs constraint</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Location Constraints:
Ordering Constraints:
  ClusterIP-clone then WebSite-clone
  WebDataClone then WebSite-clone
  WebFS-clone then WebSite-clone
Colocation Constraints:
  WebSite-clone with ClusterIP-clone
  WebFS-clone with WebDataClone (with-rsc-role:Master)
  WebSite-clone with WebFS-clone
<span class="perl_Others">#</span><span class="perl_Others"></span>
<span class="perl_Others"></span><span class="perl_Others"># pcs status</span><span class="perl_Others"></span>
<span class="perl_Others"></span>
Last updated: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">13</span>:45:<span class="perl_Float">34</span> <span class="perl_Float">2012</span>
Last change: Fri Sep <span class="perl_Float">14</span> <span class="perl_Float">13</span>:43:<span class="perl_Float">13</span> <span class="perl_Float">2012</span> via cibadmin on pcmk-<span class="perl_Float">1</span>
Stack: corosync
Current DC: pcmk-<span class="perl_Float">1</span> (<span class="perl_Float">1</span>) - partition with quorum
Version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
<span class="perl_Float">2</span> Nodes configured, unknown expected votes
<span class="perl_Float">11</span> Resources configured.

Online: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]

Full list of resources:

 Master/Slave Set: WebDataClone [WebData]
     Masters: [ pcmk-<span class="perl_Float">2</span> pcmk-<span class="perl_Float">1</span> ]
 Clone Set: dlm-clone [dlm]
     Started: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]
 Clone Set: ClusterIP-clone [ClusterIP] (unique)
     ClusterIP:0        (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">1</span>
     ClusterIP:<span class="perl_Float">1</span>        (ocf::heartbeat:IPaddr2):       Started pcmk-<span class="perl_Float">2</span>
 Clone Set: WebFS-clone [WebFS]
     Started: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]
 Clone Set: WebSite-clone [WebSite]
     Started: [ pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span> ]
 impi-fencing   (stonith:fence_ipmilan):        Started</pre><div class="para">
			In xml it should look similar to this.
		</div><pre class="programlisting"><span class="perl_Keyword">&lt;cib</span><span class="perl_Others"> admin_epoch=</span><span class="perl_String">"0"</span><span class="perl_Others"> cib-last-written=</span><span class="perl_String">"Fri Sep 14 13:43:13 2012"</span><span class="perl_Others"> crm_feature_set=</span><span class="perl_String">"3.0.6"</span><span class="perl_Others"> dc-uuid=</span><span class="perl_String">"1"</span><span class="perl_Others"> epoch=</span><span class="perl_String">"47"</span><span class="perl_Others"> have-quorum=</span><span class="perl_String">"1"</span><span class="perl_Others"> num_updates=</span><span class="perl_String">"50"</span><span class="perl_Others"> update-client=</span><span class="perl_String">"cibadmin"</span><span class="perl_Others"> update-origin=</span><span class="perl_String">"pcmk-1"</span><span class="perl_Others"> validate-with=</span><span class="perl_String">"pacemaker-1.2"</span><span class="perl_Keyword">&gt;</span>
  <span class="perl_Keyword">&lt;configuration&gt;</span>
    <span class="perl_Keyword">&lt;crm_config&gt;</span>
      <span class="perl_Keyword">&lt;cluster_property_set</span><span class="perl_Others"> id=</span><span class="perl_String">"cib-bootstrap-options"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"cib-bootstrap-options-dc-version"</span><span class="perl_Others"> name=</span><span class="perl_String">"dc-version"</span><span class="perl_Others"> value=</span><span class="perl_String">"1.1.8-1.el7-60a19ed12fdb4d5c6a6b6767f52e5391e447fec0"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"cib-bootstrap-options-cluster-infrastructure"</span><span class="perl_Others"> name=</span><span class="perl_String">"cluster-infrastructure"</span><span class="perl_Others"> value=</span><span class="perl_String">"corosync"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"cib-bootstrap-options-no-quorum-policy"</span><span class="perl_Others"> name=</span><span class="perl_String">"no-quorum-policy"</span><span class="perl_Others"> value=</span><span class="perl_String">"ignore"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"cib-bootstrap-options-stonith-enabled"</span><span class="perl_Others"> name=</span><span class="perl_String">"stonith-enabled"</span><span class="perl_Others"> value=</span><span class="perl_String">"true"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;/cluster_property_set&gt;</span>
    <span class="perl_Keyword">&lt;/crm_config&gt;</span>
    <span class="perl_Keyword">&lt;nodes&gt;</span>
      <span class="perl_Keyword">&lt;node</span><span class="perl_Others"> id=</span><span class="perl_String">"1"</span><span class="perl_Others"> type=</span><span class="perl_String">"normal"</span><span class="perl_Others"> uname=</span><span class="perl_String">"pcmk-1"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;node</span><span class="perl_Others"> id=</span><span class="perl_String">"2"</span><span class="perl_Others"> type=</span><span class="perl_String">"normal"</span><span class="perl_Others"> uname=</span><span class="perl_String">"pcmk-2"</span><span class="perl_Keyword">/&gt;</span>
    <span class="perl_Keyword">&lt;/nodes&gt;</span>
    <span class="perl_Keyword">&lt;resources&gt;</span>
      <span class="perl_Keyword">&lt;master</span><span class="perl_Others"> id=</span><span class="perl_String">"WebDataClone"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;primitive</span><span class="perl_Others"> class=</span><span class="perl_String">"ocf"</span><span class="perl_Others"> id=</span><span class="perl_String">"WebData"</span><span class="perl_Others"> provider=</span><span class="perl_String">"linbit"</span><span class="perl_Others"> type=</span><span class="perl_String">"drbd"</span><span class="perl_Keyword">&gt;</span>
          <span class="perl_Keyword">&lt;instance_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"WebData-instance_attributes"</span><span class="perl_Keyword">&gt;</span>
            <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"WebData-instance_attributes-drbd_resource"</span><span class="perl_Others"> name=</span><span class="perl_String">"drbd_resource"</span><span class="perl_Others"> value=</span><span class="perl_String">"wwwdata"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;/instance_attributes&gt;</span>
          <span class="perl_Keyword">&lt;operations&gt;</span>
            <span class="perl_Keyword">&lt;op</span><span class="perl_Others"> id=</span><span class="perl_String">"WebData-interval-60s"</span><span class="perl_Others"> interval=</span><span class="perl_String">"60s"</span><span class="perl_Others"> name=</span><span class="perl_String">"monitor"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;/operations&gt;</span>
        <span class="perl_Keyword">&lt;/primitive&gt;</span>
        <span class="perl_Keyword">&lt;meta_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"WebDataClone-meta_attributes"</span><span class="perl_Keyword">&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"WebDataClone-meta_attributes-master-node-max"</span><span class="perl_Others"> name=</span><span class="perl_String">"master-node-max"</span><span class="perl_Others"> value=</span><span class="perl_String">"1"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"WebDataClone-meta_attributes-clone-max"</span><span class="perl_Others"> name=</span><span class="perl_String">"clone-max"</span><span class="perl_Others"> value=</span><span class="perl_String">"2"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"WebDataClone-meta_attributes-clone-node-max"</span><span class="perl_Others"> name=</span><span class="perl_String">"clone-node-max"</span><span class="perl_Others"> value=</span><span class="perl_String">"1"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"WebDataClone-meta_attributes-notify"</span><span class="perl_Others"> name=</span><span class="perl_String">"notify"</span><span class="perl_Others"> value=</span><span class="perl_String">"true"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"WebDataClone-meta_attributes-master-max"</span><span class="perl_Others"> name=</span><span class="perl_String">"master-max"</span><span class="perl_Others"> value=</span><span class="perl_String">"2"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;/meta_attributes&gt;</span>
      <span class="perl_Keyword">&lt;/master&gt;</span>
      <span class="perl_Keyword">&lt;clone</span><span class="perl_Others"> id=</span><span class="perl_String">"dlm-clone"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;primitive</span><span class="perl_Others"> class=</span><span class="perl_String">"ocf"</span><span class="perl_Others"> id=</span><span class="perl_String">"dlm"</span><span class="perl_Others"> provider=</span><span class="perl_String">"pacemaker"</span><span class="perl_Others"> type=</span><span class="perl_String">"controld"</span><span class="perl_Keyword">&gt;</span>
          <span class="perl_Keyword">&lt;instance_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"dlm-instance_attributes"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;operations&gt;</span>
            <span class="perl_Keyword">&lt;op</span><span class="perl_Others"> id=</span><span class="perl_String">"dlm-interval-60s"</span><span class="perl_Others"> interval=</span><span class="perl_String">"60s"</span><span class="perl_Others"> name=</span><span class="perl_String">"monitor"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;/operations&gt;</span>
        <span class="perl_Keyword">&lt;/primitive&gt;</span>
        <span class="perl_Keyword">&lt;meta_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"dlm-clone-meta"</span><span class="perl_Keyword">&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"dlm-clone-max"</span><span class="perl_Others"> name=</span><span class="perl_String">"clone-max"</span><span class="perl_Others"> value=</span><span class="perl_String">"2"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"dlm-clone-node-max"</span><span class="perl_Others"> name=</span><span class="perl_String">"clone-node-max"</span><span class="perl_Others"> value=</span><span class="perl_String">"1"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;/meta_attributes&gt;</span>
      <span class="perl_Keyword">&lt;/clone&gt;</span>
      <span class="perl_Keyword">&lt;clone</span><span class="perl_Others"> id=</span><span class="perl_String">"ClusterIP-clone"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;primitive</span><span class="perl_Others"> class=</span><span class="perl_String">"ocf"</span><span class="perl_Others"> id=</span><span class="perl_String">"ClusterIP"</span><span class="perl_Others"> provider=</span><span class="perl_String">"heartbeat"</span><span class="perl_Others"> type=</span><span class="perl_String">"IPaddr2"</span><span class="perl_Keyword">&gt;</span>
          <span class="perl_Keyword">&lt;instance_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"ClusterIP-instance_attributes"</span><span class="perl_Keyword">&gt;</span>
            <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"ClusterIP-instance_attributes-ip"</span><span class="perl_Others"> name=</span><span class="perl_String">"ip"</span><span class="perl_Others"> value=</span><span class="perl_String">"192.168.0.120"</span><span class="perl_Keyword">/&gt;</span>
            <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"ClusterIP-instance_attributes-cidr_netmask"</span><span class="perl_Others"> name=</span><span class="perl_String">"cidr_netmask"</span><span class="perl_Others"> value=</span><span class="perl_String">"32"</span><span class="perl_Keyword">/&gt;</span>
            <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"ClusterIP-instance_attributes-clusterip_hash"</span><span class="perl_Others"> name=</span><span class="perl_String">"clusterip_hash"</span><span class="perl_Others"> value=</span><span class="perl_String">"sourceip"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;/instance_attributes&gt;</span>
          <span class="perl_Keyword">&lt;operations&gt;</span>
            <span class="perl_Keyword">&lt;op</span><span class="perl_Others"> id=</span><span class="perl_String">"ClusterIP-interval-30s"</span><span class="perl_Others"> interval=</span><span class="perl_String">"30s"</span><span class="perl_Others"> name=</span><span class="perl_String">"monitor"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;/operations&gt;</span>
        <span class="perl_Keyword">&lt;/primitive&gt;</span>
        <span class="perl_Keyword">&lt;meta_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"ClusterIP-clone-meta"</span><span class="perl_Keyword">&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"ClusterIP-globally-unique"</span><span class="perl_Others"> name=</span><span class="perl_String">"globally-unique"</span><span class="perl_Others"> value=</span><span class="perl_String">"true"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"ClusterIP-clone-max"</span><span class="perl_Others"> name=</span><span class="perl_String">"clone-max"</span><span class="perl_Others"> value=</span><span class="perl_String">"2"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"ClusterIP-clone-node-max"</span><span class="perl_Others"> name=</span><span class="perl_String">"clone-node-max"</span><span class="perl_Others"> value=</span><span class="perl_String">"2"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;/meta_attributes&gt;</span>
      <span class="perl_Keyword">&lt;/clone&gt;</span>
      <span class="perl_Keyword">&lt;clone</span><span class="perl_Others"> id=</span><span class="perl_String">"WebFS-clone"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;primitive</span><span class="perl_Others"> class=</span><span class="perl_String">"ocf"</span><span class="perl_Others"> id=</span><span class="perl_String">"WebFS"</span><span class="perl_Others"> provider=</span><span class="perl_String">"heartbeat"</span><span class="perl_Others"> type=</span><span class="perl_String">"Filesystem"</span><span class="perl_Keyword">&gt;</span>
          <span class="perl_Keyword">&lt;instance_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"WebFS-instance_attributes"</span><span class="perl_Keyword">&gt;</span>
            <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"WebFS-instance_attributes-device"</span><span class="perl_Others"> name=</span><span class="perl_String">"device"</span><span class="perl_Others"> value=</span><span class="perl_String">"/dev/drbd/by-res/wwwdata"</span><span class="perl_Keyword">/&gt;</span>
            <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"WebFS-instance_attributes-directory"</span><span class="perl_Others"> name=</span><span class="perl_String">"directory"</span><span class="perl_Others"> value=</span><span class="perl_String">"/var/www/html"</span><span class="perl_Keyword">/&gt;</span>
            <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"WebFS-instance_attributes-fstype"</span><span class="perl_Others"> name=</span><span class="perl_String">"fstype"</span><span class="perl_Others"> value=</span><span class="perl_String">"gfs2"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;/instance_attributes&gt;</span>
          <span class="perl_Keyword">&lt;meta_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"WebFS-meta_attributes"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;/primitive&gt;</span>
        <span class="perl_Keyword">&lt;meta_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"WebFS-clone-meta"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;/clone&gt;</span>
      <span class="perl_Keyword">&lt;clone</span><span class="perl_Others"> id=</span><span class="perl_String">"WebSite-clone"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;primitive</span><span class="perl_Others"> class=</span><span class="perl_String">"ocf"</span><span class="perl_Others"> id=</span><span class="perl_String">"WebSite"</span><span class="perl_Others"> provider=</span><span class="perl_String">"heartbeat"</span><span class="perl_Others"> type=</span><span class="perl_String">"apache"</span><span class="perl_Keyword">&gt;</span>
          <span class="perl_Keyword">&lt;instance_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"WebSite-instance_attributes"</span><span class="perl_Keyword">&gt;</span>
            <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"WebSite-instance_attributes-configfile"</span><span class="perl_Others"> name=</span><span class="perl_String">"configfile"</span><span class="perl_Others"> value=</span><span class="perl_String">"/etc/httpd/conf/httpd.conf"</span><span class="perl_Keyword">/&gt;</span>
            <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"WebSite-instance_attributes-statusurl"</span><span class="perl_Others"> name=</span><span class="perl_String">"statusurl"</span><span class="perl_Others"> value=</span><span class="perl_String">"http://localhost/server-status"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;/instance_attributes&gt;</span>
          <span class="perl_Keyword">&lt;operations&gt;</span>
            <span class="perl_Keyword">&lt;op</span><span class="perl_Others"> id=</span><span class="perl_String">"WebSite-interval-1min"</span><span class="perl_Others"> interval=</span><span class="perl_String">"1min"</span><span class="perl_Others"> name=</span><span class="perl_String">"monitor"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;/operations&gt;</span>
        <span class="perl_Keyword">&lt;/primitive&gt;</span>
        <span class="perl_Keyword">&lt;meta_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"WebSite-clone-meta"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;/clone&gt;</span>
      <span class="perl_Keyword">&lt;primitive</span><span class="perl_Others"> class=</span><span class="perl_String">"stonith"</span><span class="perl_Others"> id=</span><span class="perl_String">"impi-fencing"</span><span class="perl_Others"> type=</span><span class="perl_String">"fence_ipmilan"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;instance_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"impi-fencing-instance_attributes"</span><span class="perl_Keyword">&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"impi-fencing-instance_attributes-pcmk_host_list"</span><span class="perl_Others"> name=</span><span class="perl_String">"pcmk_host_list"</span><span class="perl_Others"> value=</span><span class="perl_String">"pcmk-1 pcmk-2"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"impi-fencing-instance_attributes-ipaddr"</span><span class="perl_Others"> name=</span><span class="perl_String">"ipaddr"</span><span class="perl_Others"> value=</span><span class="perl_String">"10.0.0.1"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"impi-fencing-instance_attributes-login"</span><span class="perl_Others"> name=</span><span class="perl_String">"login"</span><span class="perl_Others"> value=</span><span class="perl_String">"testuser"</span><span class="perl_Keyword">/&gt;</span>
          <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"impi-fencing-instance_attributes-passwd"</span><span class="perl_Others"> name=</span><span class="perl_String">"passwd"</span><span class="perl_Others"> value=</span><span class="perl_String">"acd123"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;/instance_attributes&gt;</span>
        <span class="perl_Keyword">&lt;operations&gt;</span>
          <span class="perl_Keyword">&lt;op</span><span class="perl_Others"> id=</span><span class="perl_String">"impi-fencing-interval-60s"</span><span class="perl_Others"> interval=</span><span class="perl_String">"60s"</span><span class="perl_Others"> name=</span><span class="perl_String">"monitor"</span><span class="perl_Keyword">/&gt;</span>
        <span class="perl_Keyword">&lt;/operations&gt;</span>
      <span class="perl_Keyword">&lt;/primitive&gt;</span>
    <span class="perl_Keyword">&lt;/resources&gt;</span>
    <span class="perl_Keyword">&lt;constraints&gt;</span>
      <span class="perl_Keyword">&lt;rsc_colocation</span><span class="perl_Others"> id=</span><span class="perl_String">"colocation-WebSite-ClusterIP-INFINITY"</span><span class="perl_Others"> rsc=</span><span class="perl_String">"WebSite-clone"</span><span class="perl_Others"> score=</span><span class="perl_String">"INFINITY"</span><span class="perl_Others"> with-rsc=</span><span class="perl_String">"ClusterIP-clone"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;rsc_order</span><span class="perl_Others"> first=</span><span class="perl_String">"ClusterIP-clone"</span><span class="perl_Others"> first-action=</span><span class="perl_String">"start"</span><span class="perl_Others"> id=</span><span class="perl_String">"order-ClusterIP-WebSite-mandatory"</span><span class="perl_Others"> then=</span><span class="perl_String">"WebSite-clone"</span><span class="perl_Others"> then-action=</span><span class="perl_String">"start"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;rsc_colocation</span><span class="perl_Others"> id=</span><span class="perl_String">"colocation-WebFS-WebDataClone-INFINITY"</span><span class="perl_Others"> rsc=</span><span class="perl_String">"WebFS-clone"</span><span class="perl_Others"> score=</span><span class="perl_String">"INFINITY"</span><span class="perl_Others"> with-rsc=</span><span class="perl_String">"WebDataClone"</span><span class="perl_Others"> with-rsc-role=</span><span class="perl_String">"Master"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;rsc_colocation</span><span class="perl_Others"> id=</span><span class="perl_String">"colocation-WebSite-WebFS-INFINITY"</span><span class="perl_Others"> rsc=</span><span class="perl_String">"WebSite-clone"</span><span class="perl_Others"> score=</span><span class="perl_String">"INFINITY"</span><span class="perl_Others"> with-rsc=</span><span class="perl_String">"WebFS-clone"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;rsc_order</span><span class="perl_Others"> first=</span><span class="perl_String">"WebFS-clone"</span><span class="perl_Others"> id=</span><span class="perl_String">"order-WebFS-WebSite-mandatory"</span><span class="perl_Others"> then=</span><span class="perl_String">"WebSite-clone"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;rsc_order</span><span class="perl_Others"> first=</span><span class="perl_String">"WebDataClone"</span><span class="perl_Others"> first-action=</span><span class="perl_String">"promote"</span><span class="perl_Others"> id=</span><span class="perl_String">"order-WebDataClone-WebFS-mandatory"</span><span class="perl_Others"> then=</span><span class="perl_String">"WebFS-clone"</span><span class="perl_Others"> then-action=</span><span class="perl_String">"start"</span><span class="perl_Keyword">/&gt;</span>
    <span class="perl_Keyword">&lt;/constraints&gt;</span>
    <span class="perl_Keyword">&lt;rsc_defaults&gt;</span>
      <span class="perl_Keyword">&lt;meta_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"rsc_defaults-options"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"rsc_defaults-options-resource-stickiness"</span><span class="perl_Others"> name=</span><span class="perl_String">"resource-stickiness"</span><span class="perl_Others"> value=</span><span class="perl_String">"100"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;/meta_attributes&gt;</span>
    <span class="perl_Keyword">&lt;/rsc_defaults&gt;</span>
    <span class="perl_Keyword">&lt;op_defaults&gt;</span>
      <span class="perl_Keyword">&lt;meta_attributes</span><span class="perl_Others"> id=</span><span class="perl_String">"op_defaults-options"</span><span class="perl_Keyword">&gt;</span>
        <span class="perl_Keyword">&lt;nvpair</span><span class="perl_Others"> id=</span><span class="perl_String">"op_defaults-options-timeout"</span><span class="perl_Others"> name=</span><span class="perl_String">"timeout"</span><span class="perl_Others"> value=</span><span class="perl_String">"240s"</span><span class="perl_Keyword">/&gt;</span>
      <span class="perl_Keyword">&lt;/meta_attributes&gt;</span>
    <span class="perl_Keyword">&lt;/op_defaults&gt;</span>
  <span class="perl_Keyword">&lt;/configuration&gt;</span>
<span class="perl_Keyword">&lt;/cib&gt;</span></pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_node_list">
      ⁠</a>A.2.&nbsp;Node List</h2></div></div></div><div class="para">
			The list of cluster nodes is automatically populated by the cluster.
		</div><pre class="literallayout">Pacemaker Nodes:
 Online: [ pcmk-1 pcmk-2  ]</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_cluster_options">
      ⁠</a>A.3.&nbsp;Cluster Options</h2></div></div></div><div class="para">
			This is where the cluster automatically stores some information about the cluster
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					dc-version - the version (including upstream source-code hash) of Pacemaker used on the DC
				</div></li><li class="listitem"><div class="para">
					cluster-infrastructure - the cluster infrastructure being used (heartbeat or openais)
				</div></li><li class="listitem"><div class="para">
					expected-quorum-votes - the maximum number of nodes expected to be part of the cluster
				</div></li></ul></div><div class="para">
			and where the admin can set options that control the way the cluster operates
		</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
					stonith-enabled=true - Make use of STONITH
				</div></li><li class="listitem"><div class="para">
					no-quorum-policy=ignore - Ignore loss of quorum and continue to host resources.
				</div></li></ul></div><pre class="programlisting"><span class="perl_Others"># pcs property</span><span class="perl_Others"></span>
<span class="perl_Others"></span>dc-version: <span class="perl_Float">1.1</span>.<span class="perl_Float">8</span>-<span class="perl_Float">1.</span>el7-<span class="perl_Float">60</span>a19ed12fdb4d5c6a6b6767f52e5391e447fec0
cluster-infrastructure: corosync
no-quorum-policy: ignore
stonith-enabled: true</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h2 class="title"><a id="_resources">
      ⁠</a>A.4.&nbsp;Resources</h2></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_default_options">
      ⁠</a>A.4.1.&nbsp;Default Options</h3></div></div></div><div class="para">
				Here we configure cluster options that apply to every resource.
			</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
						resource-stickiness - Specify the aversion to moving resources to other machines
					</div></li></ul></div><pre class="programlisting"><span class="perl_Others"># pcs resource rsc defaults</span><span class="perl_Others"></span>
<span class="perl_Others"></span>resource-stickiness: <span class="perl_Float">100</span></pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_fencing">
      ⁠</a>A.4.2.&nbsp;Fencing</h3></div></div></div><pre class="programlisting"><span class="perl_Others"># pcs stonith show</span><span class="perl_Others"></span>
<span class="perl_Others"></span> impi-fencing   (stonith:fence_ipmilan) Started
<span class="perl_Others"># pcs stonith show impi-fencing</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Resource: impi-fencing
  pcmk_host_list: pcmk-<span class="perl_Float">1</span> pcmk-<span class="perl_Float">2</span>
  ipaddr: <span class="perl_Float">10.0</span>.0.<span class="perl_Float">1</span>
  login: testuser
  passwd: acd123</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_service_address">
      ⁠</a>A.4.3.&nbsp;Service Address</h3></div></div></div><div class="para">
				Users of the services provided by the cluster require an unchanging address with which to access it. Additionally, we cloned the address so it will be active on both nodes. An iptables rule (created as part of the resource agent) is used to ensure that each request only gets processed by one of the two clone instances. The additional meta options tell the cluster that we want two instances of the clone (one "request bucket" for each node) and that if one node fails, then the remaining node should hold both.
			</div><pre class="programlisting"><span class="perl_Others"># pcs resource show ClusterIP-clone</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Resource: ClusterIP-clone
  ip: <span class="perl_Float">192.168</span>.0.<span class="perl_Float">120</span>
  cidr_netmask: <span class="perl_Float">32</span>
  clusterip_hash: sourceip
  globally-unique: true
  clone-max: <span class="perl_Float">2</span>
  clone-node-max: <span class="perl_Float">2</span>
  op monitor interval=<span class="perl_Float">30</span>s</pre><div xmlns:d="http://docbook.org/ns/docbook" class="note"><div class="admonition_header"><p><strong>Note</strong></p></div><div class="admonition"><div class="para">
					TODO: The RA should check for globally-unique=true when cloned
				</div></div></div></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_drbd_shared_storage">
      ⁠</a>A.4.4.&nbsp;DRBD - Shared Storage</h3></div></div></div><div class="para">
				Here we define the DRBD service and specify which DRBD resource (from drbd.conf) it should manage. We make it a master/slave resource and, in order to have an active/active setup, allow both instances to be promoted by specifying master-max=2. We also set the notify option so that the cluster will tell DRBD agent when it’s peer changes state.
			</div><pre class="programlisting"><span class="perl_Others"># pcs resource show WebDataClone</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Resource: WebDataClone
  drbd_resource: wwwdata
  master-node-max: <span class="perl_Float">1</span>
  clone-max: <span class="perl_Float">2</span>
  clone-node-max: <span class="perl_Float">1</span>
  notify: true
  master-max: <span class="perl_Float">2</span>
  op monitor interval=<span class="perl_Float">60</span>s
<span class="perl_Others"># pcs constraint ref WebDataClone</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Resource: WebDataClone
  colocation-WebFS-WebDataClone-INFINITY
  order-WebDataClone-WebFS-mandatory</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_cluster_filesystem">
      ⁠</a>A.4.5.&nbsp;Cluster Filesystem</h3></div></div></div><div class="para">
				The cluster filesystem ensures that files are read and written correctly. We need to specify the block device (provided by DRBD), where we want it mounted and that we are using GFS2. Again it is a clone because it is intended to be active on both nodes. The additional constraints ensure that it can only be started on nodes with active gfs-control and drbd instances.
			</div><pre class="programlisting"><span class="perl_Others"># pcs resource show WebFS-clone</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Resource: WebFS-clone
  device: /dev/drbd/by-res/wwwdata
  directory: /var/www/html
  fstype: gfs2
<span class="perl_Others"># pcs constraint ref WebFS-clone</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Resource: WebFS-clone
  colocation-WebFS-WebDataClone-INFINITY
  colocation-WebSite-WebFS-INFINITY
  order-WebFS-WebSite-mandatory
  order-WebDataClone-WebFS-mandatory</pre></div><div class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h3 class="title"><a id="_apache">
      ⁠</a>A.4.6.&nbsp;Apache</h3></div></div></div><div class="para">
				Lastly we have the actual service, Apache. We need only tell the cluster where to find it’s main configuration file and restrict it to running on nodes that have the required filesystem mounted and the IP address active.
			</div><pre class="programlisting"><span class="perl_Others"># pcs resource show WebSite-clone</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Resource: WebSite-clone
  configfile: /etc/httpd/conf/httpd.conf
  statusurl: http:<span class="perl_Comment">//localhost/server-status</span><span class="perl_Comment"></span>
<span class="perl_Comment"></span>  master-max: <span class="perl_Float">2</span>
  op monitor interval=<span class="perl_Float">1</span>min
<span class="perl_Others"># pcs constraint ref WebSite-clone</span><span class="perl_Others"></span>
<span class="perl_Others"></span>Resource: WebSite-clone
  colocation-WebSite-ClusterIP-INFINITY
  colocation-WebSite-WebFS-INFINITY
  order-ClusterIP-WebSite-mandatory
  order-WebFS-WebSite-mandatory</pre></div></div></div><div xml:lang="en-US" class="appendix" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="_sample_corosync_configuration"></a>Sample Corosync Configuration</h1></div></div></div><div class="para"><div xmlns:d="http://docbook.org/ns/docbook" class="title">Sample corosync.conf for two-node cluster using a node list.</div>
			
<pre class="literallayout"># Please read the corosync.conf.5 manual page
totem {
version: 2
secauth: off
cluster_name: mycluster
transport: udpu
}

nodelist {
  node {
        ring0_addr: pcmk-1
        nodeid: 1
  }
  node {
        ring0_addr: pcmk-2
        nodeid: 2
  }
}

quorum {
  provider: corosync_votequorum
}

logging {
  to_syslog: yes
}</pre>
		</div></div><div xml:lang="en-US" class="appendix" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="_further_reading"></a>Further Reading</h1></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
				Project Website <a href="http://www.clusterlabs.org/">http://www.clusterlabs.org</a>
			</div></li><li class="listitem"><div class="para">
				Cluster Commands A comprehensive guide to cluster commands has been written by SuSE and can be found at: <a href="http://www.suse.com/documentation/sle_ha/book_sleha/?page=/documentation/sle_ha/book_sleha/data/book_sleha.html">http://www.suse.com/documentation/sle_ha/book_sleha/?page=/documentation/sle_ha/book_sleha/data/book_sleha.html</a>
			</div></li><li class="listitem"><div class="para">
				Corosync <a href="http://www.corosync.org/">http://www.corosync.org</a>
			</div></li></ul></div></div><div xml:lang="en-US" class="appendix" lang="en-US"><div class="titlepage"><div><div><h1 class="title"><a id="appe-Clusters_from_Scratch-Revision_History"></a>Revision History</h1></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" class="para"><p></p>
		<div class="revhistory"><table summary="Revision History"><tbody><tr><th align="left" valign="top" colspan="3"><strong>Revision History</strong></th></tr><tr><td align="left">Revision 1-0</td><td align="left">Mon May 17 2010</td><td align="left"><span class="author"><span class="firstname">Andrew</span> <span class="surname">Beekhof</span></span></td></tr><tr><td align="left" colspan="3">
					<table border="0" summary="Simple list" class="simplelist"><tbody><tr><td>Import from Pages.app</td></tr></tbody></table>
				</td></tr><tr><td align="left">Revision 2-0</td><td align="left">Wed Sep 22 2010</td><td align="left"><span class="author"><span class="firstname">Raoul</span> <span class="surname">Scarazzini</span></span></td></tr><tr><td align="left" colspan="3">
					<table border="0" summary="Simple list" class="simplelist"><tbody><tr><td>Italian translation</td></tr></tbody></table>
				</td></tr><tr><td align="left">Revision 3-0</td><td align="left">Wed Feb 9 2011</td><td align="left"><span class="author"><span class="firstname">Andrew</span> <span class="surname">Beekhof</span></span></td></tr><tr><td align="left" colspan="3">
					<table border="0" summary="Simple list" class="simplelist"><tbody><tr><td>Updated for Fedora 13</td></tr></tbody></table>
				</td></tr><tr><td align="left">Revision 4-0</td><td align="left">Wed Oct 5 2011</td><td align="left"><span class="author"><span class="firstname">Andrew</span> <span class="surname">Beekhof</span></span></td></tr><tr><td align="left" colspan="3">
					<table border="0" summary="Simple list" class="simplelist"><tbody><tr><td>Update the GFS2 section to use CMAN</td></tr></tbody></table>
				</td></tr><tr><td align="left">Revision 5-0</td><td align="left">Fri Feb 10 2012</td><td align="left"><span class="author"><span class="firstname">Andrew</span> <span class="surname">Beekhof</span></span></td></tr><tr><td align="left" colspan="3">
					<table border="0" summary="Simple list" class="simplelist"><tbody><tr><td>Generate docbook content from asciidoc sources</td></tr></tbody></table>
				</td></tr><tr><td align="left">Revision 6-0</td><td align="left">Tues July 3 2012</td><td align="left"><span class="author"><span class="firstname">Andrew</span> <span class="surname">Beekhof</span></span></td></tr><tr><td align="left" colspan="3">
					<table border="0" summary="Simple list" class="simplelist"><tbody><tr><td>Updated for Fedora 17</td></tr></tbody></table>
				</td></tr><tr><td align="left">Revision 7-0</td><td align="left">Fri Sept 14 2012</td><td align="left"><span class="author"><span class="firstname">David</span> <span class="surname">Vossel</span></span></td></tr><tr><td align="left" colspan="3">
					<table border="0" summary="Simple list" class="simplelist"><tbody><tr><td>Updated for pcs</td></tr></tbody></table>
				</td></tr></tbody></table></div>

	</div></div><div class="index"><div class="titlepage"><div><div><h1 class="title"><a id="idm254557660928">
      ⁠</a>Index</h1></div></div></div><div class="index"><div class="indexdiv"><h3>C</h3><dl><dt>Creating and Activating a new SSH Key, <a class="indexterm" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configure_ssh">Configure SSH</a></dt></dl></div><div class="indexdiv"><h3>D</h3><dl><dt>Domain name (Query), <a class="indexterm" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_short_node_names">Short Node Names</a></dt><dt>Domain name (Remove from host name), <a class="indexterm" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_short_node_names">Short Node Names</a></dt></dl></div><div class="indexdiv"><h3>F</h3><dl><dt>feedback</dt><dd><dl><dt>contact information for this manual, <a class="indexterm" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#idm254584875696">We Need Feedback!</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>N</h3><dl><dt>Nodes</dt><dd><dl><dt>Domain name (Query), <a class="indexterm" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_short_node_names">Short Node Names</a></dt><dt>Domain name (Remove from host name), <a class="indexterm" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_short_node_names">Short Node Names</a></dt><dt>short name, <a class="indexterm" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_short_node_names">Short Node Names</a></dt></dl></dd></dl></div><div class="indexdiv"><h3>S</h3><dl><dt>short name, <a class="indexterm" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_short_node_names">Short Node Names</a></dt><dt>SSH, <a class="indexterm" href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html-single/Clusters_from_Scratch/index.html#_configure_ssh">Configure SSH</a></dt></dl></div></div></div></div></body></html>